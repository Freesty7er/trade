
#Область Создание_Открытие

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	КомпоновщикНастроекИнициализировать()
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	Если ТекущийОбъект.ХранилищеНастроекКомпоновкиДанных <> Неопределено Тогда
		ЭтаФорма.АдресНастроекСКД = ПоместитьВоВременноеХранилище(ТекущийОбъект.ХранилищеНастроекКомпоновкиДанных.Получить());
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область Запись

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	АдресНастроекСКД = ПоместитьВоВременноеХранилище(КомпоновщикНастроек.Настройки);
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	ТекущийОбъект.ХранилищеНастроекКомпоновкиДанных = Новый ХранилищеЗначения(ПолучитьИзВременногоХранилища(ЭтаФорма.АдресНастроекСКД));
	
КонецПроцедуры

#КонецОбласти

#Область ЦелевойПоказатель_Изменение

&НаКлиенте
Процедура ЦелевойПоказательПриИзменении(Элемент)
	
	АдресНастроекСКД = "";
	
	КомпоновщикНастроекИнициализировать();
	
КонецПроцедуры

#КонецОбласти

&НаКлиенте
Процедура КомпоновщикНастроекИнициализировать()
	
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных;
	
	Если ЗначениеЗаполнено(Запись.ЦелевойПоказатель) Тогда
		
		Если АдресНастроекСКД <> "" Тогда
			настройки = ПолучитьИзВременногоХранилища(АдресНастроекСКД);
		Иначе
			настройки = Запись.ЦелевойПоказатель.ХранилищеНастроекКомпоновкиДанных.Получить();
		КонецЕсли;
		
		СхемаКомпоновкиДанных = Запись.ЦелевойПоказатель.СхемаКомпоновкиДанных.Получить();
		
		Если СхемаКомпоновкиДанных = Неопределено Тогда
			
			цп_АдресСКД = "";
			цп_АдресНастроекСКД = "";
			
			АдресаСхемаКомпоновкиДанныхПоИмяШаблонаСКД = СегментыВызовСервера.ПолучитьАдресаСхемыКомпоновкиДанныхВоВременномХранилище(Запись.ЦелевойПоказатель.Ссылка,Запись.ЦелевойПоказатель.ИмяШаблонаСКД,цп_АдресСКД,цп_АдресНастроекСКД,УникальныйИдентификатор);
			СхемаКомпоновкиДанных = ПолучитьИзВременногоХранилища(АдресаСхемаКомпоновкиДанныхПоИмяШаблонаСКД.СхемаКомпоновкиДанных);
			
		КонецЕсли;
		
		КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКомпоновкиДанных));
		
		Если настройки = Неопределено Тогда
			настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
		КонецЕсли;
		
		КомпоновщикНастроек.ЗагрузитьНастройки(настройки);
		КомпоновщикНастроек.Восстановить();
		
	КонецЕсли;
	
КонецПроцедуры

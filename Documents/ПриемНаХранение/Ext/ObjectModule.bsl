
#Область ОбработчикиСобытий

Процедура ПриКопировании(объектКопирования)
	
	ЗаполнениеОбъектовСервер.ЗаполнитьДанныеСкопированногоДокумента(ЭтотОбъект, объектКопирования);
	
КонецПроцедуры

Процедура ОбработкаЗаполнения(данныеЗаполнения, стандартнаяОбработка)
	
	ЗаполнениеОбъектовСервер.ЗаполнитьДанныеНовогоДокумента(ЭтотОбъект, данныеЗаполнения);
	
	Если Подразделение.Пустая() Тогда
		Подразделение = ПользователиСервер.ПолучитьЗначениеНастройки("ОсновноеПодразделение");
	КонецЕсли; 
	
	Если Ответственный.Пустая() Тогда
		Ответственный = ПользователиСервер.ПолучитьЗначениеНастройки("ОсновнойОтветственный");
	КонецЕсли;
		
КонецПроцедуры

Процедура ПередЗаписью(отказ, режимЗаписи, режимПроведения)
	
	соХарактеристикиЯрлыков = ПолучитьХарактеристикиЯрлыков(Состав.ВыгрузитьКолонку("Ярлык"));
		
	Для Каждого строкаСостава Из Состав Цикл
		СуммаДокумента = Окр(строкаСостава.Количество * соХарактеристикиЯрлыков[строкаСостава.Ярлык].Цена, 2, РежимОкругления.Окр15как20);
	КонецЦикла
	
КонецПроцедуры

Процедура ОбработкаПроведения(отказ, режимПроведения)
	
	Движения.ТоварыНаОтветственномХранении.Записывать = Истина;
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ
	|	ПриемНаХранениеСостав.Ссылка.Дата КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ПриемНаХранениеСостав.Ссылка.Подразделение,
	|	ПриемНаХранениеСостав.Ссылка.Получатель КАК МестоХранения,
	|	ПриемНаХранениеСостав.Ярлык,
	|	ПриемНаХранениеСостав.Количество
	|ИЗ
	|	Документ.ПриемНаХранение.Состав КАК ПриемНаХранениеСостав
	|ГДЕ
	|	ПриемНаХранениеСостав.Ссылка = &ТекущийДокумент";
	
	#КонецОбласти
	
	запрос.УстановитьПараметр("ТекущийДокумент", Ссылка);
	
	результатЗапроса = запрос.Выполнить();
	
	Движения.ТоварыНаОтветственномХранении.Загрузить(результатЗапроса.Выгрузить());
	
КонецПроцедуры

#КонецОбласти

#Область ДополнительныеПроцедурыИФункции

Функция ПолучитьХарактеристикиЯрлыков(мНоменклатура = Неопределено)
	
	соХарактеристикиЯрлыков = Новый Соответствие;
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ
	|	Ярлыки.Ссылка,
	|	Ярлыки.СтоимостьЕдиницыХранения
	|ИЗ
	|	Справочник.Ярлыки КАК Ярлыки
	|ГДЕ
	|	Ярлыки.Ссылка В(&мНоменклатура)";
	
	#КонецОбласти
	
	запрос.УстановитьПараметр("мНоменклатура", мНоменклатура);
	
	результатЗапроса = запрос.Выполнить();
	
	выборка = результатЗапроса.Выбрать();
	Пока выборка.Следующий() Цикл
		соХарактеристикиЯрлыков.Вставить(выборка.Ссылка, Новый Структура("Цена",выборка.СтоимостьЕдиницыХранения));	
	КонецЦикла;
	
	Возврат (соХарактеристикиЯрлыков);
	
КонецФункции

#КонецОбласти
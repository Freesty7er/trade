

#Область КомандыФормы

&НаКлиенте
Процедура ЗаполнитьТорговыеТочки(команда)
	
	ПоказатьВопрос(Новый ОписаниеОповещения("ЗаполнитьТорговыеТочкиЗавершение", ЭтотОбъект), 
        НСтр("ru='Список торговых точек будет очищен. Продолжить?'"), 
        РежимДиалогаВопрос.ДаНет, 
        10, 
        КодВозвратаДиалога.Да, 
        НСтр("ru='Вопрос о продолжении'"), 
        КодВозвратаДиалога.Нет
    	);
	
КонецПроцедуры

#КонецОбласти

#Область ОписанияОповещений

&НаКлиенте
Процедура ЗаполнитьТорговыеТочкиЗавершение(результатВопроса, дополнительныеПараметры) Экспорт
	
	Если Не результатВопроса = КодВозвратаДиалога.Да Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ЗаполнитьТорговыеТочкиНаСервере();

КонецПроцедуры
	
#КонецОбласти 

#Область ДополнительныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьТорговыеТочкиНаСервере()
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КД_КатегорииТорговыхТочекСрезПоследних.ТорговаяТочка.Ссылка КАК Контрагент
	|ИЗ
	|	РегистрСведений.КД_КатегорииТорговыхТочек.СрезПоследних(
	|			&ДатаСреза,
	|			КатегорияТТ = &КД_Категория
	|				И Подразделение = &Подразделение
	|				И ТорговаяТочка.КД_Состояние = &Активна
	|				И ТорговаяТочка.ПометкаУдаления = ЛОЖЬ) КАК КД_КатегорииТорговыхТочекСрезПоследних";
		
	#КонецОбласти
	
	запрос.УстановитьПараметр("ДатаСреза", КонецДня(Объект.Дата));
	запрос.УстановитьПараметр("Подразделение", Объект.Подразделение);
	запрос.УстановитьПараметр("КД_Категория", Объект.КатегорияТорговойТочки);
	запрос.УстановитьПараметр("Активна", Справочники.КД_СостоянияТТ.НайтиПоКоду("000000001"));
	
	результатЗапроса = запрос.Выполнить();
	
	Если результатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Объект.ТорговыйТочки.Загрузить(результатЗапроса.Выгрузить());
	
КонецПроцедуры
	
#КонецОбласти 
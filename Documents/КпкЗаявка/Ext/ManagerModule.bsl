
// Возвращает информацию о долгах контрагента согласно данным переданного документа.
//
// Параметры:
//  Объект  - ДокументСсылка.КпкЗаявка, ДанныеФормыСтруктура - Ссылка документа или
//                 данные формы документа, для которого будут получены долги контрагента.
//
// Возвращаемое значение:
//   Структура   - Информация о долгах контрагента. Содержит следующие свойства:
//                 ДолгВсеМенеджеры  - Число - Долг контрагента по всем менеджерам.
//                 ДолгМенеджер  - Число - Долг контрагента по выбранному менеджеру.
//                 ДолгПросроченный  - Число - Просроченный долг контрагента.
//
Функция ПолучитьИнформациюОДолгахКонтрагента(Объект) Экспорт

	Запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЕСТЬNULL(ДолгПоВсемМенеджерам.СуммаОстаток, 0) КАК ДолгВсеМенеджеры,
	|	ЕСТЬNULL(ДолгПоМенеджеру.СуммаОстаток, 0) КАК ДолгМенеджер,
	|	ЕСТЬNULL(ПросроченныйДолг.СуммаОстаток, 0) КАК ДолгПросроченный
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВзаиморасчетыСПокупателями.Остатки(
	|				&Период,
	|				Контрагент = &Контрагент
	|					И Подразделение = &Подразделение) КАК ДолгПоВсемМенеджерам
	|		ПО Контрагенты.Ссылка = ДолгПоВсемМенеджерам.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВзаиморасчетыСПокупателями.Остатки(
	|				&Период,
	|				Контрагент = &Контрагент
	|					И Подразделение = &Подразделение
	|					И Менеджер = &Менеджер) КАК ДолгПоМенеджеру
	|		ПО Контрагенты.Ссылка = ДолгПоМенеджеру.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВзаиморасчетыСПокупателями.Остатки(
	|				&Период,
	|				Контрагент = &Контрагент
	|					И Подразделение = &Подразделение
	|					И Менеджер = &Менеджер
	|					И ДОБАВИТЬКДАТЕ(КредитныйДокумент.Дата, ДЕНЬ, Контрагент.СрокОплаты + 7 + 1) < &Период) КАК ПросроченныйДолг
	|		ПО Контрагенты.Ссылка = ПросроченныйДолг.Контрагент
	|ГДЕ
	|	Контрагенты.Ссылка = &Контрагент";
	#КонецОбласти
	
	запрос.УстановитьПараметр("Период", Объект.Дата);
	запрос.УстановитьПараметр("Контрагент", Объект.Контрагент);
	запрос.УстановитьПараметр("Подразделение", Объект.Подразделение);
	запрос.УстановитьПараметр("Валюта", Константы.ВалютаУчета.Получить());
	запрос.УстановитьПараметр("Менеджер", Объект.Менеджер);
	
	выборка = Запрос.Выполнить().Выбрать();
	выборка.Следующий();
	
	стДолги = Новый Структура("ДолгВсеМенеджеры,ДолгМенеджер,ДолгПросроченный");
	ЗаполнитьЗначенияСвойств(стДолги, Выборка);
	
	Возврат стДолги;

КонецФункции // ПолучитьИнформациюОДолгахКонтрагента()

Функция ПолучитьПлановыеДанныеДляВнутреннегоЗаказа(периодЗаполнения, подразделение, отделВМагазине) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	запрос = Новый Запрос;
	запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ
	|	КпкЗаявка.Ссылка
	|ПОМЕСТИТЬ ВТ_СпецЗаказы
	|ИЗ
	|	Документ.КпкЗаявка КАК КпкЗаявка
	|ГДЕ
	|	КпкЗаявка.Проведен = ИСТИНА
	|	И КпкЗаявка.СпецЗаказ = ИСТИНА
	|	И ДОБАВИТЬКДАТЕ(КпкЗаявка.ДатаДоставки, ДЕНЬ, 1) МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И КпкЗаявка.Контрагент = &ТорговаяТочка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(СгруппированныеПродажиОстатки.КонечныйОстаток) КАК КонечныйОстаток,
	|	СУММА(СгруппированныеПродажиОстатки.Продажи) КАК Продажи,
	|	СгруппированныеПродажиОстатки.Номенклатура КАК Номенклатура,
	|	СгруппированныеПродажиОстатки.Подразделение КАК Подразделение,
	|	СгруппированныеПродажиОстатки.ОтделМагазина КАК ОтделМагазина,
	|	МАКСИМУМ(СгруппированныеПродажиОстатки.МинимальныйОстаток) КАК МинимальныйОстаток,
	|	СУММА(СгруппированныеПродажиОстатки.ПродажиСпецЗаказ) КАК ПродажиСпецЗаказ,
	|	СУММА(СгруппированныеПродажиОстатки.ПродажиСреднееНеделя) КАК ПродажиСреднееНеделя
	|ПОМЕСТИТЬ ВТ_СгруппированныеПродажиОстатки
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТоварыВРозницеОстаткиИОбороты.Подразделение КАК Подразделение,
	|		ТоварыВРозницеОстаткиИОбороты.ОтделМагазина КАК ОтделМагазина,
	|		ТоварыВРозницеОстаткиИОбороты.Номенклатура КАК Номенклатура,
	|		ТоварыВРозницеОстаткиИОбороты.КоличествоКонечныйОстаток КАК КонечныйОстаток,
	|		0 КАК Продажи,
	|		0 КАК МинимальныйОстаток,
	|		0 КАК ПродажиСпецЗаказ,
	|		0 КАК ПродажиСреднееНеделя
	|	ИЗ
	|		РегистрНакопления.ТоварыВРознице.ОстаткиИОбороты(
	|				&ДатаНачала,
	|				&ДатаОкончания,
	|				,
	|				,
	|				Подразделение = &Подразделение
	|					И ОтделМагазина = &ОтделМагазина) КАК ТоварыВРозницеОстаткиИОбороты
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПродажиОбороты.Подразделение,
	|		ПродажиОбороты.ЦФО,
	|		ПродажиОбороты.Номенклатура,
	|		0,
	|		ПродажиОбороты.КоличествоОборот,
	|		0,
	|		0,
	|		0
	|	ИЗ
	|		РегистрНакопления.Продажи.Обороты(
	|				&ДатаНачала,
	|				&ДатаОкончания,
	|				,
	|				Подразделение = &Подразделение
	|					И ЦФО = &ОтделМагазина) КАК ПродажиОбороты
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		&Подразделение,
	|		&ОтделМагазина,
	|		КД_СтандартПрисутствия.Номенклатура,
	|		0,
	|		0,
	|		ЕСТЬNULL(КД_СтандартПрисутствия.МинимальныйОстаток, 0),
	|		0,
	|		0
	|	ИЗ
	|		(ВЫБРАТЬ
	|			КД_КатегорииТорговыхТочекСрезПоследних.Подразделение КАК Подразделение,
	|			КД_КатегорииТорговыхТочекСрезПоследних.ГруппаПродукции КАК ГруппаПродукции,
	|			КД_КатегорииТорговыхТочекСрезПоследних.КатегорияТТ КАК КатегорияТТ,
	|			КД_КатегорииТорговыхТочекСрезПоследних.ТорговаяТочка КАК ТорговаяТочка,
	|			МАКСИМУМ(КД_СтандартПрисутствия.Период) КАК ПериодСтандарта,
	|			МАКСИМУМ(КД_СтандартПрисутствия1.Период) КАК ПериодСтандартаТТ
	|		ИЗ
	|			РегистрСведений.КД_КатегорииТорговыхТочек.СрезПоследних(ДОБАВИТЬКДАТЕ(&ДатаОкончания, ДЕНЬ, 1), ) КАК КД_КатегорииТорговыхТочекСрезПоследних
	|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КД_СтандартПрисутствия КАК КД_СтандартПрисутствия
	|				ПО КД_КатегорииТорговыхТочекСрезПоследних.Подразделение = КД_СтандартПрисутствия.Подразделение
	|					И КД_КатегорииТорговыхТочекСрезПоследних.ГруппаПродукции = КД_СтандартПрисутствия.ГруппаПродукции
	|					И КД_КатегорииТорговыхТочекСрезПоследних.КатегорияТТ = КД_СтандартПрисутствия.КатегорияТТ
	|					И (КД_СтандартПрисутствия.Период МЕЖДУ НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОкончания, ДЕНЬ, 1), МЕСЯЦ) И КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОкончания, ДЕНЬ, 1), МЕСЯЦ))
	|					И (КД_СтандартПрисутствия.ТорговаяТочка = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КД_СтандартПрисутствия КАК КД_СтандартПрисутствия1
	|				ПО КД_КатегорииТорговыхТочекСрезПоследних.Подразделение = КД_СтандартПрисутствия1.Подразделение
	|					И КД_КатегорииТорговыхТочекСрезПоследних.ГруппаПродукции = КД_СтандартПрисутствия1.ГруппаПродукции
	|					И КД_КатегорииТорговыхТочекСрезПоследних.КатегорияТТ = КД_СтандартПрисутствия1.КатегорияТТ
	|					И (КД_СтандартПрисутствия1.Период МЕЖДУ НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОкончания, ДЕНЬ, 1), МЕСЯЦ) И КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОкончания, ДЕНЬ, 1), МЕСЯЦ))
	|					И КД_КатегорииТорговыхТочекСрезПоследних.ТорговаяТочка = КД_СтандартПрисутствия1.ТорговаяТочка
	|		ГДЕ
	|			КД_КатегорииТорговыхТочекСрезПоследних.ТорговаяТочка = &ТорговаяТочка
	|		
	|		СГРУППИРОВАТЬ ПО
	|			КД_КатегорииТорговыхТочекСрезПоследних.Подразделение,
	|			КД_КатегорииТорговыхТочекСрезПоследних.ГруппаПродукции,
	|			КД_КатегорииТорговыхТочекСрезПоследних.КатегорияТТ,
	|			КД_КатегорииТорговыхТочекСрезПоследних.ТорговаяТочка) КАК ПериодыСтандартаПоГруппеПродукта
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КД_СтандартПрисутствия КАК КД_СтандартПрисутствия
	|			ПО ПериодыСтандартаПоГруппеПродукта.Подразделение = КД_СтандартПрисутствия.Подразделение
	|				И ПериодыСтандартаПоГруппеПродукта.ГруппаПродукции = КД_СтандартПрисутствия.ГруппаПродукции
	|				И ПериодыСтандартаПоГруппеПродукта.КатегорияТТ = КД_СтандартПрисутствия.КатегорияТТ
	|				И (ВЫБОР
	|					КОГДА ПериодыСтандартаПоГруппеПродукта.ПериодСтандартаТТ ЕСТЬ NULL 
	|						ТОГДА КД_СтандартПрисутствия.ТорговаяТочка = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|					ИНАЧЕ КД_СтандартПрисутствия.ТорговаяТочка = ПериодыСтандартаПоГруппеПродукта.ТорговаяТочка
	|				КОНЕЦ)
	|				И (ВЫБОР
	|					КОГДА ПериодыСтандартаПоГруппеПродукта.ПериодСтандартаТТ ЕСТЬ NULL 
	|						ТОГДА КД_СтандартПрисутствия.Период = ПериодыСтандартаПоГруппеПродукта.ПериодСтандарта
	|					ИНАЧЕ КД_СтандартПрисутствия.Период = ПериодыСтандартаПоГруппеПродукта.ПериодСтандартаТТ
	|				КОНЕЦ)
	|				И (КД_СтандартПрисутствия.ТипПриоритета = ЗНАЧЕНИЕ(Перечисление.КД_ТипыПриоритетовПродукта.Обязательный)
	|					ИЛИ КД_СтандартПрисутствия.ТипПриоритета = ЗНАЧЕНИЕ(Перечисление.КД_ТипыПриоритетовПродукта.Рекомендуемый))
	|	ГДЕ
	|		НЕ КД_СтандартПрисутствия.Номенклатура ЕСТЬ NULL 
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		&Подразделение,
	|		&ОтделМагазина,
	|		ЗаказыПокупателей.Номенклатура,
	|		0,
	|		-ЗаказыПокупателей.Отгружено,
	|		0,
	|		ЗаказыПокупателей.Отгружено,
	|		0
	|	ИЗ
	|		РегистрНакопления.ЗаказыПокупателей КАК ЗаказыПокупателей
	|	ГДЕ
	|		ЗаказыПокупателей.ЗаказПокупателя В
	|				(ВЫБРАТЬ
	|					ВТ_СпецЗаказы.Ссылка
	|				ИЗ
	|					ВТ_СпецЗаказы КАК ВТ_СпецЗаказы)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПродажиОбороты.Подразделение,
	|		ПродажиОбороты.ЦФО,
	|		ПродажиОбороты.Номенклатура,
	|		СУММА(0),
	|		СУММА(0),
	|		СУММА(0),
	|		СУММА(0),
	|		СРЕДНЕЕ(ПродажиОбороты.КоличествоОборот)
	|	ИЗ
	|		РегистрНакопления.Продажи.Обороты(
	|				ДОБАВИТЬКДАТЕ(&ДатаНачала, ДЕНЬ, -7),
	|				&ДатаОкончания,
	|				День,
	|				Подразделение = &Подразделение
	|					И ЦФО = &ОтделМагазина) КАК ПродажиОбороты
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ПродажиОбороты.Подразделение,
	|		ПродажиОбороты.ЦФО,
	|		ПродажиОбороты.Номенклатура) КАК СгруппированныеПродажиОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	СгруппированныеПродажиОстатки.Подразделение,
	|	СгруппированныеПродажиОстатки.ОтделМагазина,
	|	СгруппированныеПродажиОстатки.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.Подразделение КАК Подразделение,
	|	ВложенныйЗапрос.ОтделМагазина,
	|	ВложенныйЗапрос.Номенклатура,
	|	ВложенныйЗапрос.Продажи,
	|	ВложенныйЗапрос.КонечныйОстаток,
	|	ВложенныйЗапрос.КратностьУпаковки,
	|	ВложенныйЗапрос.КоэффициентРекомендуемогоЗапаса,
	|	ВложенныйЗапрос.КоэффициентВыравнивания,
	|	ВложенныйЗапрос.КодЕдИзм,
	|	ВложенныйЗапрос.МинимальныйОстаток,
	|	ВложенныйЗапрос.РекомендуемыйЗапас,
	|	ВЫБОР
	|		КОГДА ВложенныйЗапрос.МинимальныйОстаток > 0
	|			ТОГДА ВЫБОР
	|					КОГДА ВложенныйЗапрос.МинимальныйОстаток > ВложенныйЗапрос.КонечныйОстаток + ВложенныйЗапрос.РекомендуемыйЗапас
	|						ТОГДА ВложенныйЗапрос.МинимальныйОстаток - ВложенныйЗапрос.КонечныйОстаток
	|					ИНАЧЕ ВложенныйЗапрос.РекомендуемыйЗапас
	|				КОНЕЦ
	|		ИНАЧЕ ВложенныйЗапрос.РекомендуемыйЗапас
	|	КОНЕЦ КАК РекомендуемыйЗаказ,
	|	ВложенныйЗапрос.ПродажиСпецЗаказ,
	|	ВложенныйЗапрос.ПродажиСреднееНеделя
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВТ_СгруппированныеПродажиОстатки.Подразделение КАК Подразделение,
	|		ВТ_СгруппированныеПродажиОстатки.ОтделМагазина КАК ОтделМагазина,
	|		ВТ_СгруппированныеПродажиОстатки.Номенклатура КАК Номенклатура,
	|		ВТ_СгруппированныеПродажиОстатки.Продажи КАК Продажи,
	|		ВТ_СгруппированныеПродажиОстатки.КонечныйОстаток КАК КонечныйОстаток,
	|		ВЫБОР
	|			КОГДА ВТ_СгруппированныеПродажиОстатки.Номенклатура.БПАГКратностьУпаковки = 0
	|				ТОГДА 0.1
	|			ИНАЧЕ ВТ_СгруппированныеПродажиОстатки.Номенклатура.БПАГКратностьУпаковки
	|		КОНЕЦ КАК КратностьУпаковки,
	|		ЕСТЬNULL(БПАГКоэффициентыРекомендуемогоЗапасаСрезПоследних.Коэффициент, 0) КАК КоэффициентРекомендуемогоЗапаса,
	|		ЕСТЬNULL(БПАГКоэффициентыВыравниванияВЗаказеСрезПоследних.Коэффициент, 0.5) КАК КоэффициентВыравнивания,
	|		ВТ_СгруппированныеПродажиОстатки.Номенклатура.ЕдиницаИзмерения.Код КАК КодЕдИзм,
	|		ВЫБОР
	|			КОГДА ВТ_СгруппированныеПродажиОстатки.Продажи * ЕСТЬNULL(БПАГКоэффициентыРекомендуемогоЗапасаСрезПоследних.Коэффициент, 0) - ВЫБОР
	|					КОГДА ВТ_СгруппированныеПродажиОстатки.КонечныйОстаток < 0
	|						ТОГДА 0
	|					ИНАЧЕ ВТ_СгруппированныеПродажиОстатки.КонечныйОстаток
	|				КОНЕЦ > 0
	|				ТОГДА ВТ_СгруппированныеПродажиОстатки.Продажи * ЕСТЬNULL(БПАГКоэффициентыРекомендуемогоЗапасаСрезПоследних.Коэффициент, 0) - ВЫБОР
	|						КОГДА ВТ_СгруппированныеПродажиОстатки.КонечныйОстаток < 0
	|							ТОГДА 0
	|						ИНАЧЕ ВТ_СгруппированныеПродажиОстатки.КонечныйОстаток
	|					КОНЕЦ
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК РекомендуемыйЗапас,
	|		ВТ_СгруппированныеПродажиОстатки.МинимальныйОстаток КАК МинимальныйОстаток,
	|		ВТ_СгруппированныеПродажиОстатки.ПродажиСпецЗаказ КАК ПродажиСпецЗаказ,
	|		ВТ_СгруппированныеПродажиОстатки.ПродажиСреднееНеделя КАК ПродажиСреднееНеделя
	|	ИЗ
	|		ВТ_СгруппированныеПродажиОстатки КАК ВТ_СгруппированныеПродажиОстатки
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.БПАГКоэффициентыРекомендуемогоЗапаса.СрезПоследних(&ДатаОкончания, ) КАК БПАГКоэффициентыРекомендуемогоЗапасаСрезПоследних
	|			ПО ВТ_СгруппированныеПродажиОстатки.Номенклатура.КД_Вид = БПАГКоэффициентыРекомендуемогоЗапасаСрезПоследних.НоменклатурнаяГруппа
	|				И ВТ_СгруппированныеПродажиОстатки.ОтделМагазина.Магазин = БПАГКоэффициентыРекомендуемогоЗапасаСрезПоследних.Контрагент
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.БПАГКоэффициентыВыравниванияВЗаказе.СрезПоследних(&ДатаОкончания, ) КАК БПАГКоэффициентыВыравниванияВЗаказеСрезПоследних
	|			ПО ВТ_СгруппированныеПродажиОстатки.Номенклатура.КД_Вид = БПАГКоэффициентыВыравниванияВЗаказеСрезПоследних.НоменклатурнаяГруппа) КАК ВложенныйЗапрос
	|ГДЕ
	|	ВложенныйЗапрос.МинимальныйОстаток > 0";
	#КонецОбласти
	
	запрос.УстановитьПараметр("ДатаНачала", 	периодЗаполнения.ДатаНачала);
	запрос.УстановитьПараметр("ДатаОкончания", 	периодЗаполнения.ДатаОкончания);
	запрос.УстановитьПараметр("Подразделение", 	подразделение);
	запрос.УстановитьПараметр("ОтделМагазина", 	отделВМагазине);
	запрос.УстановитьПараметр("ТорговаяТочка", 	отделВМагазине.Магазин);
	
	результатЗапроса = запрос.Выполнить();
	
	#Область ПолучениеВременныхТаблиц
	
	запрос.Текст =
	"ВЫБРАТЬ * ИЗ ВТ_СпецЗаказы;
	|ВЫБРАТЬ * ИЗ ВТ_СгруппированныеПродажиОстатки";
	
	#КонецОбласти
	
	Возврат результатЗапроса;
	
КонецФункции	// ПолучитьПлановыеДанныеДляВнутреннегоЗаказа()

Перем КаталогНаСервере Экспорт;

Процедура ДополнитьСлешВПуть(Каталог) Экспорт
	
	Если Прав(Каталог, 1) <> "\" Тогда
		Каталог = Каталог + "\";
	КонецЕсли;
	
КонецПроцедуры //ДополнитьСлешВПуть

Процедура ВыгрузкаНакладных()
	
	УстановитьПривилегированныйРежим(Истина);
	
	//Каталог = КаталогОбмена;
	Каталог = КаталогНаСервере;
	
	ДополнитьСлешВПуть(Каталог);
		
	ИмяФайла = Каталог + "RN_"+Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yy_MM_dd")+"_"+Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yy_MM_dd")+".xml";
		
	Накладные = Новый ЗаписьXML;
		
	Накладные.ОткрытьФайл(ИмяФайла, "windows-1251");
		
	Накладные.ЗаписатьОбъявлениеXML();
		
	Накладные.ЗаписатьНачалоЭлемента("Document");
	Накладные.ЗаписатьАтрибут("Version", 	"1.0");
	Накладные.ЗаписатьАтрибут("Type",		"Document");
	Накладные.ЗаписатьАтрибут("Kind",		"RN");
	Накладные.ЗаписатьАтрибут("ID_Supplier","6");
	Накладные.ЗаписатьАтрибут("Date", 		Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd"));
	Накладные.ЗаписатьАтрибут("Time",		Прав(ТекущаяДата(), 8));
	Накладные.ЗаписатьАтрибут("StartDate",	Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yyyy-MM-dd"));
	Накладные.ЗаписатьАтрибут("EndDate",	Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yyyy-MM-dd"));
	
	Для Каждого СтрокаНакладных Из РасходныеНакладные Цикл
		
		ТекущийДокумент = СтрокаНакладных.Ссылка;
		
		// ВыборкаДокументов
		Накладные.ЗаписатьНачалоЭлемента("Doc");
		Накладные.ЗаписатьАтрибут("ID_DOC",			СокрЛП(ТекущийДокумент.Номер));
		Накладные.ЗаписатьАтрибут("STATE",			"1");
		Накладные.ЗаписатьАтрибут("DATE",			Формат(ТекущийДокумент.Дата, "ДФ=yyyy-MM-dd"));
		Накладные.ЗаписатьАтрибут("TIME",			Прав(ТекущийДокумент.Дата, 8));
		Накладные.ЗаписатьАтрибут("Buyer_ID",		СокрЛП(ТекущийДокумент.Контрагент.Код));
		Накладные.ЗаписатьАтрибут("Recipient",		СокрЛП(ТекущийДокумент.Контрагент.Наименование));
		Накладные.ЗаписатьАтрибут("Recipient_GLN",	СокрЛП(ТекущийДокумент.Контрагент.GLN));
		
		
		Накладные.ЗаписатьНачалоЭлемента("Table");
		
		Для Каждого СтрокаСостава Из ТекущийДокумент.Запасы Цикл
			
			// ВыборкаСтрок
			Накладные.ЗаписатьНачалоЭлемента("Line");
			Накладные.ЗаписатьАтрибут("SKU_ID", 	Формат(СтрокаСостава.Номенклатура.Код,"ЧГ=0"));
			Накладные.ЗаписатьАтрибут("Quantity", 	Формат(СтрокаСостава.Количество,"ЧРД=.; ЧГ=0"));
			Накладные.ЗаписатьАтрибут("Price", 		Формат(СтрокаСостава.Цена, "ЧРД=.; ЧГ=0"));
			Накладные.ЗаписатьАтрибут("Amount",		Формат(СтрокаСостава.Сумма, "ЧРД=.; ЧГ=0"));
			
			Накладные.ЗаписатьКонецЭлемента(); //Line
			
		КонецЦикла;
		
		Накладные.ЗаписатьКонецЭлемента(); //Table
		
		Накладные.ЗаписатьКонецЭлемента(); //Doc
		
	КонецЦикла;
		
	Накладные.ЗаписатьКонецЭлемента(); //Document
		
	Накладные.Закрыть();
	
КонецПроцедуры

Процедура ВыгрузкаНоменклатуры()
	
	//Каталог = КаталогОбмена;
	Каталог = КаталогНаСервере;
	
	ДополнитьСлешВПуть(Каталог);
		
	ИмяФайла = Каталог + "SKU_"+Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yy_MM_dd")+"_"+Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yy_MM_dd")+".xml";
		
	СписокНоменклатуры = Новый ЗаписьXML;
		
	СписокНоменклатуры.ОткрытьФайл(ИмяФайла, "windows-1251");
		
	СписокНоменклатуры.ЗаписатьОбъявлениеXML();
		
	СписокНоменклатуры.ЗаписатьНачалоЭлемента("Document");
	СписокНоменклатуры.ЗаписатьАтрибут("Version", 	"1.0");
	СписокНоменклатуры.ЗаписатьАтрибут("Type",		"Catalog");
	СписокНоменклатуры.ЗаписатьАтрибут("Kind",		"SKU");
	СписокНоменклатуры.ЗаписатьАтрибут("ID_Supplier",	"6");
	СписокНоменклатуры.ЗаписатьАтрибут("Date", 		Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd"));
	СписокНоменклатуры.ЗаписатьАтрибут("Time",		Прав(ТекущаяДата(), 8));
	
	Для Каждого СтрокаНоменклатуры Из Номенклатура Цикл
		
		ТекущаяНоменклатура = СтрокаНоменклатуры.Ссылка;
		
		// ВыборкаНоменклатура
		СписокНоменклатуры.ЗаписатьНачалоЭлемента("Item");
		
		СписокНоменклатуры.ЗаписатьАтрибут("ID", 		Формат(ТекущаяНоменклатура.Код, "ЧГ=0"));
		СписокНоменклатуры.ЗаписатьАтрибут("Name", 		СокрЛП(ТекущаяНоменклатура.Наименование));
		СписокНоменклатуры.ЗаписатьАтрибут("BarCode", "0");
		СписокНоменклатуры.ЗаписатьАтрибут("Article", "");
		
		СписокНоменклатуры.ЗаписатьКонецЭлемента(); //<Item 
		
	КонецЦикла;
	
	СписокНоменклатуры.ЗаписатьКонецЭлемента(); //Document
		
	СписокНоменклатуры.Закрыть();	
	
КонецПроцедуры	// ВыгрузкаНоменклатуры()

Процедура ВыгрузкаКонтрагентов()
	
	//Каталог = КаталогОбмена;
	Каталог = КаталогНаСервере;
	
	ДополнитьСлешВПуть(Каталог);
		
	ИмяФайла = Каталог + "BU_"+Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yy_MM_dd")+"_"+Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yy_MM_dd")+".xml";
	
		
	ТорговыеТочки = Новый ЗаписьXML;
		
	ТорговыеТочки.ОткрытьФайл(ИмяФайла, "windows-1251");
		
	ТорговыеТочки.ЗаписатьОбъявлениеXML();
		
	ТорговыеТочки.ЗаписатьНачалоЭлемента("Document");
	ТорговыеТочки.ЗаписатьАтрибут("Version", 	"1.0");
	ТорговыеТочки.ЗаписатьАтрибут("Type",		"Catalog");
	ТорговыеТочки.ЗаписатьАтрибут("Kind",		"Buyers");
	ТорговыеТочки.ЗаписатьАтрибут("ID_Supplier","6");
	ТорговыеТочки.ЗаписатьАтрибут("Date", 		Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd"));
	ТорговыеТочки.ЗаписатьАтрибут("Time",		Прав(ТекущаяДата(), 8));
	
	Для Каждого СтрокаКонтрагенты Из Контрагенты Цикл
		
		ТекущийКонтрагент = СтрокаКонтрагенты.Ссылка;
		
		ТорговыеТочки.ЗаписатьНачалоЭлемента("Item");
		
		ТорговыеТочки.ЗаписатьАтрибут("ID",			Формат(ТекущийКонтрагент.Код, "ЧГ=0"));
		ТорговыеТочки.ЗаписатьАтрибут("Name",		СокрЛП(ТекущийКонтрагент.Наименование));
		ТорговыеТочки.ЗаписатьАтрибут("FullName", 	СокрЛП(ТекущийКонтрагент.ПолнНаим));
		ТорговыеТочки.ЗаписатьАтрибут("OKPO", 		"");
		
		ТорговыеТочки.ЗаписатьКонецЭлемента(); //Item
		
	КонецЦикла;
	
	ТорговыеТочки.ЗаписатьКонецЭлемента(); //Document
		
	ТорговыеТочки.Закрыть();	
	
КонецПроцедуры	// ВыгрузкаТорговыхТочек()

Функция ВыгрузитьДанныеВ_XML() Экспорт
	
	ВыгрузкаНакладных();
	
	ВыгрузкаНоменклатуры();
	
	ВыгрузкаКонтрагентов();
	
	
	// Архивирование
	//Каталог = КаталогОбмена;
	Каталог = КаталогНаСервере;
	
	ДополнитьСлешВПуть(Каталог);
	
	ИмяАрхива = "6_"+Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yy_MM_dd")+"_"+Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yy_MM_dd")+".zip";
	ПутьИмяАрхива = Каталог + ИмяАрхива;
		
	Архив = Новый ЗаписьZipФайла(ПутьИмяАрхива, , , , УровеньСжатияZIP.Максимальный);
	
	ИмяФайла = Каталог + "RN_"+Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yy_MM_dd")+"_"+Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yy_MM_dd")+".xml";
	Архив.Добавить(ИмяФайла);
	
	ИмяФайла = Каталог + "SKU_"+Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yy_MM_dd")+"_"+Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yy_MM_dd")+".xml";
	Архив.Добавить(ИмяФайла);
	
	ИмяФайла = Каталог + "BU_"+Формат(ПериодВыгрузки.ДатаНачала, "ДФ=yy_MM_dd")+"_"+Формат(ПериодВыгрузки.ДатаОкончания, "ДФ=yy_MM_dd")+".xml";
	Архив.Добавить(ИмяФайла);
	
	Архив.Записать();
	
	Результат = Новый Структура("ПутьИмяАрхива, ИмяАрхива", ПутьИмяАрхива, ИмяАрхива);
	
	Возврат (Результат);
	
КонецФункции

КаталогНаСервере = "\\192.168.8.195\kpk\EXCHANGE";
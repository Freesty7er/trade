//Функция ПолучитьДанныеПоШтрихкодам(Штрихкоды) Экспорт

//	ДанныеПоШтрихкодам = Новый Соответствие;

//	Запрос = Новый Запрос(
//	"ВЫБРАТЬ
//	|	Рег.Штрихкод КАК Штрихкод,
//	|	Рег.Номенклатура КАК Номенклатура,
//	|	Рег.Характеристика КАК Характеристика,
//	|	Рег.Партия КАК Партия,
//	|	Рег.ЕдиницаИзмерения КАК ЕдиницаИзмерения
//	|ИЗ
//	|	РегистрСведений.ШтрихкодыНоменклатуры КАК Рег
//	|ГДЕ
//	|	Рег.Штрихкод В(&МассивШтрихкодов)");

//	МассивШтрихкодов = Новый Массив;

//	Для каждого ТекШтрихкод Из Штрихкоды Цикл
//		МассивШтрихкодов.Добавить(ТекШтрихкод.ШтрихКод);
//		ДанныеПоШтрихкодам.Вставить(ТекШтрихкод.ШтрихКод, Новый Структура);
//	КонецЦикла;

//	Запрос.УстановитьПараметр("МассивШтрихкодов", МассивШтрихкодов);

//	Выборка = Запрос.Выполнить().Выбрать();
//	Пока Выборка.Следующий() Цикл
//		ТекДанные = ДанныеПоШтрихкодам[Выборка.Штрихкод];
//		ТекДанные.Вставить("Номенклатура", Выборка.Номенклатура);
//		ТекДанные.Вставить("Характеристика", Выборка.Характеристика);
//		ТекДанные.Вставить("Партия", Выборка.Партия);
//		ТекДанные.Вставить("ЕдиницаИзмерения", Выборка.ЕдиницаИзмерения);
//	КонецЦикла;

//	Возврат ДанныеПоШтрихкодам;

//КонецФункции


#Область ГенерацияШтрихКодов

// Функция вычисляет контрольный символ кода EAN
//
// Параметры:
//  ШтрихКод     - штрихкод (без контрольной цифры)
//  Тип          - тип штрихкода: 13 - EAN13, 8 - EAN8
//
// Возвращаемое значение:
//  Контрольный символ штрихкода
//
Функция КонтрольныйСимволEAN(штрихКод, тип) Экспорт
	
	четн   = 0;
	нечетн = 0;
	
	количествоИтераций = ?(тип = 13, 6, 4);
	
	Для индекс = 1 По количествоИтераций Цикл
		
		Если (тип = 8) и (индекс = количествоИтераций) Тогда
		Иначе
			четн   = четн   + Сред(штрихКод, 2 * индекс, 1);
		КонецЕсли;
		
		нечетн = нечетн + Сред(штрихКод, 2 * индекс - 1, 1);
		
	КонецЦикла;
	
	Если тип = 13 Тогда
		четн = четн * 3;
	Иначе
		нечетн = нечетн * 3;
	КонецЕсли;
	
	контЦифра = 10 - (четн + нечетн) % 10;
	
	Возврат ?(контЦифра = 10, "0", Строка(контЦифра));
	
КонецФункции // КонтрольныйСимволEAN()

Функция ПолучитьМаксимальноеЗначениеКодаШтрихкодаЧислом(префиксШтучногоТовара = "0", префиксВнутреннегоШтрихкода = "00") Экспорт

	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ
	|	МАКСИМУМ(ПОДСТРОКА(ШтрихкодыНоменклатуры.Штрихкод, 5, 8)) КАК Код
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	ШтрихкодыНоменклатуры.Штрихкод ПОДОБНО ""2" + ПрефиксШтучногоТовара + ПрефиксВнутреннегоШтрихкода + "_________""
	|";
	
	#КонецОбласти

	выборка = Запрос.Выполнить().Выбрать();
	выборка.Следующий();
	
	описаниеТипаЧисла = Новый ОписаниеТипов("Число");
	значениеКодаЧислом = ОписаниеТипаЧисла.ПривестиЗначение(выборка.Код);
	
	Возврат значениеКодаЧислом;

КонецФункции // ПолучитьМаксимальноеЗначениеКодаШтрихкодаЧислом()

Функция ПолучитьШтрихкодПоКоду(код, префиксШтучногоТовара = "0", префиксВнутреннегоШтрихкода = "00") Экспорт

	штрихкод = "2" + префиксШтучногоТовара + префиксВнутреннегоШтрихкода + Формат(код, "ЧЦ=8; ЧВН=; ЧГ=");
	штрихкод = штрихкод + КонтрольныйСимволEAN(штрихКод, 13);
	
	Возврат штрихкод;

КонецФункции // ПолучитьШтрихкодПоКоду()

// Функция осуществляет формирование нового внутреннего штрихкода для
// штучного товара
//
// Параметры
//  Код  – <Число> 
//       – Измерение "Код" регистра сведений Штрихкоды
//
// Возвращаемое значение:
//  <Строка>
//       – сформированный штрихкод
//
Функция СформироватьШтрихкодEAN13(префиксШтучногоТовара = "0", префиксВнутреннегоШтрихкода = "00") Экспорт
	
	код = Мин(ПолучитьМаксимальноеЗначениеКодаШтрихкодаЧислом(префиксШтучногоТовара, префиксВнутреннегоШтрихкода) + 1, 99999999);

	Возврат ПолучитьШтрихкодПоКоду(код, префиксШтучногоТовара, префиксВнутреннегоШтрихкода);

КонецФункции // СформироватьШтрихкодEAN13()

#КонецОбласти

//#Если Клиент Тогда
	
Функция ПроверкаНастроекАгентСервера(ПапкаОбмена, АдресСервера, НомерПорта) Экспорт
	
	ЕстьОшибки = Ложь;
	
	Если ПустаяСтрока(АдресСервера) Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не указано значение константы ""Адрес сервера""!");
	КонецЕсли;
	
	Если Найти(АдресСервера, " ") <> 0 Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Неправильно указан адрес сервера в константе ""Адрес сервера"" (в адресе есть символы ""пробел"")!");
	КонецЕсли;
	
	Поз = Найти(АдресСервера, ":");
	Если Поз = 0 Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Неправильно указан адрес сервера в константе ""Адрес сервера"" (в адресе нет символа "":"" после которого указывается номер Интернет-порта)!");
	КонецЕсли;
	
	ОшибкаПорта = Ложь;
	Попытка
		НомерПорта = Число(Сред(АдресСервера,Поз+1));
		Если НомерПорта <= 0 Тогда
			ОшибкаПорта = Истина;
		КонецЕсли;
	Исключение
		ОшибкаПорта = Истина;
	КонецПопытки;
	
	Если ОшибкаПорта Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Неправильно указан номер порта в адресе сервера (константа ""Адрес сервера"")! Номер порта должен быть больше нуля!");
	КонецЕсли;
	
	Если СтрДлина(ПапкаОбмена) = 1 Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Неправильно указано значение в константе ""Адрес сервера"")! Слишком короткий путь к папке обмена данными!");
	КонецЕсли;
	
	Если ПустаяСтрока(ПапкаОбмена) Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не указано значение константы ""Папка обмена""!");
	КонецЕсли;
	
	КаталогНаДиске = Новый Файл(ПапкаОбмена);
	Если Не КаталогНаДиске.Существует() Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не существует каталога, указанного в константе ""Папка обмена""!");
	КонецЕсли;   	
	
	Если (Прав(ПапкаОбмена, 1) = "\") И (ЕстьОшибки = 0) Тогда
	    ПапкаОбмена = Лев(ПапкаОбмена, СтрДлина(ПапкаОбмена) - 1);
	КонецЕсли;
	
	КаталогОбмена = Новый Файл(ПапкаОбмена);
	Если (НЕ КаталогОбмена.Существует()) И (ЕстьОшибки = 0) Тогда
		ЕстьОшибки = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Неправильно указано значение в константе ""Адрес сервера"")! Папка не существует!");
	КонецЕсли;
	
	Возврат ЕстьОшибки;
	
КонецФункции //ПроверкаНастроек()

Процедура ГенерацияФайлаНастроек() Экспорт
		
	ПапкаОбмена  = СокрЛП(Константы.кпкАПСПапкаОбмена.Получить());
	АдресСервера = СокрЛП(Константы.кпкАПССервер.Получить());
	
	НомерПорта = "";
	
	Если ПроверкаНастроекАгентСервера(ПапкаОбмена, АдресСервера, НомерПорта) Тогда	
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Обнаружены ошибки в значениях констант! Создание фала настроек невозможно!");
		Возврат;
	КонецЕсли;
 	
	Сообщить("Значение констант успешно проверено!", СтатусСообщения.Информация);
	
	//Создаем XML-файл через обычный объект "Текст" (просто более компактный код, чем через V7Plus.dll).
	
	Текст = Новый ТекстовыйДокумент;
	Текст.ДобавитьСтроку("<?xml version=""1.0"" encoding=""UTF-16""?>");
	Текст.ДобавитьСтроку("<APlusServer VERSION=""2.5"">");
	Текст.ДобавитьСтроку("<ServerConfig PortExternal=""" + Строка(Формат(НомерПорта, "ЧГ=0"))+""" />");
	Текст.ДобавитьСтроку("<!-- PortExternal - номер порта для запросов от КПК -->");
	Текст.ДобавитьСтроку("<!-- Образец описания настроек для КПК: -->");
	Текст.ДобавитьСтроку("<!-- PPC DEVICE_ID=""00000000-0000-0000-0000-000000000000"" PSEUDONIM=""Agent1"" DIRECTORY=""PPC1"" -->");
    
	//заносим в файл настроек идентификаторы задействованых КПК и их привязку к агентам
	КолПользователей = 0;   	
		
	Выборка = РегистрыСведений.кпкСведенияАгента.Выбрать();
	
	Пока Выборка.Следующий() Цикл		
		НаимАгента 	= СтрЗаменить(СокрЛП(Выборка.Объект.Наименование),"""","'");
		ПапкаАгента = СокрЛП(Выборка.АПСПапка);
		Если Выборка.КПК.Пустая() Тогда
		    ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Пропущен агент " + НаимАгента + ": не указан КПК!");
			Продолжить;
		Иначе
			ИДКПК = СокрЛП(Выборка.КПК.Идентификатор);
		КонецЕсли;
		Если ПустаяСтрока(ПапкаАгента) Тогда
		    ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Пропущен агент " + НаимАгента + ": не указана папка обмена!");
			Продолжить;
		КонецЕсли;
		Если ПустаяСтрока(ИДКПК) Тогда
		    ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Пропущен агент " + НаимАгента + ": не указан идентификатор КПК!");
			Продолжить;
		КонецЕсли;
		Если СтрДлина(ИДКПК) <> 36 Тогда
		    ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Пропущен агент " + НаимАгента + ": неправильно указан идентификатор КПК (длина <> 36 символов)!");
			Продолжить;
		КонецЕсли;
		
		КолПользователей = КолПользователей + 1;
		Текст.ДобавитьСтроку("<PPC DEVICE_ID=""" + ИДКПК + """ PSEUDONIM=""" + Лев(НаимАгента, 60) + """ DIRECTORY=""" + ПапкаАгента + """ />");
		Сообщить(Строка(КолПользователей) + ". Выгружены данные для агента: " + НаимАгента);
	КонецЦикла;
	
	Сообщить("Выгружено пользователей: " + Строка(КолПользователей));	
	
	Если КолПользователей <> 0 Тогда
		Текст.ДобавитьСтроку("</APlusServer>");
		ИмяФайла = ПапкаОбмена + "\config.xml";
		//Если Вопрос("Записать новый файл настроек """ + ИмяФайла + """ ?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да Тогда
			Текст.Записать(ИмяФайла, КодировкаТекста.UTF16);
			Сообщить("Записан файл настроек: "+ИмяФайла);
			Сообщить("Перезапустите Агент+ Сервер, если он был до этого запущен.");
			//Если Вопрос("Показать новый файл настроек?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да Тогда
			//	ЗапуститьПриложение(ИмяФайла);
			//КонецЕсли;
		//КонецЕсли;
	Иначе
		Сообщить("Не указаны настройки для работы с сервером ни для одного торгового агента! Файл настроек не создан!");	
		//Предупреждение("Не указаны настройки для работы с сервером ни для одного торгового агента! Файл настроек не создан!", 30);	
	КонецЕсли;
КонецПроцедуры

//#КонецЕсли

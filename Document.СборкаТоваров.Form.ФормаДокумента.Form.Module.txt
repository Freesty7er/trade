
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Элементы.ИсходнаяНоменклатураЦена.ТолькоПросмотр = Не РольДоступна("ИзменениеЦенВДокументах");
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиСобытий

&НаКлиенте
Процедура ИсходнаяНоменклатураПриИзменении(Элемент)
	ИсходнаяНоменклатураПриИзмененииНаСервере(Элемент.ТекущиеДанные.НомерСтроки - 1);
КонецПроцедуры

&НаКлиенте
Процедура ИсходнаяНоменклатураНоменклатураПриИзменении(Элемент)
	ИсходнаяНоменклатураНоменклатураПриИзмененииНаСервере(Элементы.ИсходнаяНоменклатура.ТекущиеДанные.НомерСтроки - 1);
КонецПроцедуры

&НаКлиенте
Процедура ТипЦенПриИзменении(Элемент)
	ИсходнаяНоменклатураОбновить();
КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	ИсходнаяНоменклатураОбновить();
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	НоменклатураПриИзмененииНаСервере();
КонецПроцедуры

#КонецОбласти

#Область ДополнительныеПроцедурыИФункции

&НаСервере
Процедура ИсходнаяНоменклатураПриИзмененииНаСервере(текущиеДанныеИндексСтроки)
	
	текущиеДанные = Объект.ИсходнаяНоменклатура[текущиеДанныеИндексСтроки];
	
	текущиеДанные.Цена = 0;
	текущиеДанные.Сумма = 0;
	
	Если ЗначениеЗаполнено(текущиеДанные.Номенклатура) Тогда
		
		запросЦеныНоменклатуры = Новый Запрос;
		
		#Область ТексЗапроса
		запросЦеныНоменклатуры.Текст = 
		"ВЫБРАТЬ
		|	ЦеныНоменклатурыСрезПоследних.Цена
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
		|			&ДатаДокумента,
		|			Подразделение = &Подразделение
		|				И Номенклатура = &Номенклатура
		|				И ТипЦен = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних";
		#КонецОбласти
		
		запросЦеныНоменклатуры.УстановитьПараметр("ДатаДокумента",Объект.Дата);
		запросЦеныНоменклатуры.УстановитьПараметр("Подразделение",Объект.Подразделение);
		запросЦеныНоменклатуры.УстановитьПараметр("Номенклатура",текущиеДанные.Номенклатура);
		запросЦеныНоменклатуры.УстановитьПараметр("ТипЦен",Объект.ТипЦен);
		
		результатЦеныНоменклатуры = запросЦеныНоменклатуры.Выполнить();
		Если Не результатЦеныНоменклатуры.Пустой() Тогда
			номенклатураЦена = результатЦеныНоменклатуры.Выгрузить().Получить(0).Цена;
			текущиеДанные.Цена = номенклатураЦена;
			текущиеДанные.Сумма = текущиеДанные.Количество * номенклатураЦена;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ИсходнаяНоменклатураОбновить()
	Для Каждого исходнаяНоменклатураСтрока Из Объект.ИсходнаяНоменклатура Цикл
		ИсходнаяНоменклатураПриИзмененииНаСервере(исходнаяНоменклатураСтрока.НомерСтроки - 1);
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ПодразделениеПриИзменении(Элемент)
	ИсходнаяНоменклатураОбновить();
КонецПроцедуры

&НаСервере
Процедура НоменклатураПриИзмененииНаСервере()
	
	Если ЗначениеЗаполнено(Объект.Номенклатура) Тогда
		Объект.Склад = Объект.Номенклатура.Родитель.Склад;
	Иначе
		Объект.Склад = Справочники.СтруктурныеЕдиницы.ПустаяСсылка();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ИсходнаяНоменклатураНоменклатураПриИзмененииНаСервере(текущиеДанныеИндексСтроки)
	
	текущиеДанные = Объект.ИсходнаяНоменклатура[текущиеДанныеИндексСтроки];
	
	Если ЗначениеЗаполнено(текущиеДанные.Номенклатура) Тогда
		текущиеДанные.Склад = текущиеДанные.Номенклатура.Родитель.Склад;
	Иначе
		текущиеДанные.Склад = Справочники.СтруктурныеЕдиницы.ПустаяСсылка();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
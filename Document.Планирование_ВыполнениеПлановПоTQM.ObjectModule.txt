
#Область ОбработчикиСобытий

Процедура ПриКопировании(объектКопирования)
	
	ЗаполнениеОбъектовСервер.ЗаполнитьДанныеСкопированногоДокумента(ЭтотОбъект, объектКопирования);
	
КонецПроцедуры

Процедура ОбработкаЗаполнения(данныеЗаполнения, стандартнаяОбработка)
	
	заполненНаОснованииДокумента = Ложь;

	ЗаполнениеОбъектовСервер.ЗаполнитьДанныеНовогоДокумента(ЭтотОбъект, данныеЗаполнения);
	
	// Заполнение по умолчанию
	Если Подразделение.Пустая() Тогда
		Подразделение = ПользователиСервер.ПолучитьЗначениеНастройки("ОсновноеПодразделение");
	КонецЕсли; 
	
	Если Ответственный.Пустая() Тогда
		Ответственный = ПользователиСервер.ПолучитьЗначениеНастройки("ОсновнойОтветственный");
	КонецЕсли;
	
	// Ввод на основании.
	типДанныхЗаполнения = ТипЗнч(данныеЗаполнения);
	
	Если типДанныхЗаполнения = Тип("Структура") Тогда
		
		ЗаполнитьДокументПоОтбору(данныеЗаполнения);
		
	ИначеЕсли типДанныхЗаполнения = Тип("ДокументСсылка.Планирование_УстановкаПлановПоTQM") Тогда
		
		ЗаполнитьДокументНаОснованииУстановкиПлановПоTQM(данныеЗаполнения);
		заполненНаОснованииДокумента = Истина;
		
	КонецЕсли;
		
КонецПроцедуры

Процедура ОбработкаПроведения(отказ, режимПроведения)
	
	Движения.ВзаиморасчетыССотрудниками.Записывать = Истина;
	Движения.ФинансовыйРезультат.Записывать = Истина;
	Движения.РасчетыПоОплатеТруда.Записывать = Истина;
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Ссылка.Подразделение,
	|	НАЧАЛОПЕРИОДА(Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Ссылка.Дата, МЕСЯЦ) КАК ПериодРегистрации,
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Ссылка.Дата КАК Период,
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Сотрудник,
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.ВидРасчета,
	|	СУММА(Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Результат) КАК Результат,
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Сотрудник.КатегорияРаботника.СтатьяЗатратПоЗарплате КАК СтатьяЗатрат
	|ПОМЕСТИТЬ ВТ_ДанныеДокумента
	|ИЗ
	|	Документ.Планирование_ВыполнениеПлановПоTQM.РасчетЗарплаты КАК Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты
	|ГДЕ
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Ссылка = &Ссылка
	|	И Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Результат <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Ссылка.Подразделение,
	|	НАЧАЛОПЕРИОДА(Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Ссылка.Дата, МЕСЯЦ),
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Сотрудник,
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.ВидРасчета,
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Сотрудник.КатегорияРаботника.СтатьяЗатратПоЗарплате,
	|	Планирование_ВыполнениеПлановПоTQMРасчетЗарплаты.Ссылка.Дата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ВТ_ДанныеДокумента.Период,
	|	ВТ_ДанныеДокумента.Подразделение,
	|	ВТ_ДанныеДокумента.Сотрудник,
	|	ЗНАЧЕНИЕ(ПланСчетов.Внутренний.Зарплата) КАК СчетУчета,
	|	ВТ_ДанныеДокумента.Результат КАК Сумма
	|ИЗ
	|	ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ДанныеДокумента.Период,
	|	ВТ_ДанныеДокумента.Подразделение,
	|	ВТ_ДанныеДокумента.СтатьяЗатрат,
	|	СУММА(ВТ_ДанныеДокумента.Результат) КАК СуммаРасходов
	|ИЗ
	|	ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_ДанныеДокумента.Период,
	|	ВТ_ДанныеДокумента.Подразделение,
	|	ВТ_ДанныеДокумента.СтатьяЗатрат
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ДанныеДокумента.Период,
	|	ВТ_ДанныеДокумента.Подразделение,
	|	ВТ_ДанныеДокумента.Сотрудник,
	|	ВТ_ДанныеДокумента.ПериодРегистрации,
	|	ВТ_ДанныеДокумента.ВидРасчета,
	|	ВТ_ДанныеДокумента.Результат
	|ИЗ
	|	ВТ_ДанныеДокумента КАК ВТ_ДанныеДокумента";
	
	#КонецОбласти
	
	запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	результатЗапроса = запрос.ВыполнитьПакет();
	
	Движения.ВзаиморасчетыССотрудниками.Загрузить(результатЗапроса[1].Выгрузить());
	Движения.ФинансовыйРезультат.Загрузить(результатЗапроса[2].Выгрузить());
	Движения.РасчетыПоОплатеТруда.Загрузить(результатЗапроса[3].Выгрузить());
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ЗаполнениеПоОснованию

Процедура ЗаполнитьДокументПоОтбору(Знач данныеЗаполнения)
	
КонецПроцедуры	

Процедура ЗаполнитьДокументНаОснованииУстановкиПлановПоTQM(Знач данныеЗаполнения)
	
	УстановитьПривилегированныйРежим(Истина);
	
	// Заполнение реквизитов документа.
	ЗаполнениеОбъектовСервер.ЗаполнитьРеквизитыДокументаПриВводеНаОсновании(ЭтотОбъект, данныеЗаполнения);
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ
	|	Планирование_УстановкаПлановПоTQMСостав.КатегорияТРТ.Родитель.ГруппаПродукта КАК ГруппаПродукта,
	|	Планирование_УстановкаПлановПоTQMСостав.Ссылка.Подразделение,
	|	Планирование_УстановкаПлановПоTQMСостав.ТипПриоритета
	|ПОМЕСТИТЬ ВТ_ГруппыПродукта
	|ИЗ
	|	Документ.Планирование_УстановкаПлановПоTQM.Состав КАК Планирование_УстановкаПлановПоTQMСостав
	|ГДЕ
	|	Планирование_УстановкаПлановПоTQMСостав.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	Планирование_УстановкаПлановПоTQMСостав.КатегорияТРТ.Родитель.ГруппаПродукта,
	|	Планирование_УстановкаПлановПоTQMСостав.Ссылка.Подразделение,
	|	Планирование_УстановкаПлановПоTQMСостав.ТипПриоритета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	БПАГСторЧек.Менеджер,
	|	БПАГСторЧек.КД_ГруппаПродукта,
	|	БПАГСторЧек.Подразделение
	|ПОМЕСТИТЬ ВТ_Менеджеры
	|ИЗ
	|	Документ.БПАГСторЧек КАК БПАГСторЧек
	|ГДЕ
	|	БПАГСторЧек.Проведен = ИСТИНА
	|	И БПАГСторЧек.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И БПАГСторЧек.Подразделение В
	|			(ВЫБРАТЬ
	|				ВТ_ГруппыПродукта.Подразделение
	|			ИЗ
	|				ВТ_ГруппыПродукта КАК ВТ_ГруппыПродукта)
	|	И БПАГСторЧек.КД_ГруппаПродукта В
	|			(ВЫБРАТЬ
	|				ВТ_ГруппыПродукта.ГруппаПродукта
	|			ИЗ
	|				ВТ_ГруппыПродукта КАК ВТ_ГруппыПродукта)
	|
	|СГРУППИРОВАТЬ ПО
	|	БПАГСторЧек.Менеджер,
	|	БПАГСторЧек.КД_ГруппаПродукта,
	|	БПАГСторЧек.Подразделение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Менеджеры.Менеджер,
	|	ВТ_ГруппыПродукта.ТипПриоритета
	|ИЗ
	|	ВТ_ГруппыПродукта КАК ВТ_ГруппыПродукта,
	|	ВТ_Менеджеры КАК ВТ_Менеджеры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Менеджеры.Менеджер,
	|	КД_НазначенияТорговыхПредставителейСрезПоследних.Сотрудник
	|ИЗ
	|	ВТ_Менеджеры КАК ВТ_Менеджеры
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КД_НазначенияТорговыхПредставителей.СрезПоследних(&ДатаОкончания, ) КАК КД_НазначенияТорговыхПредставителейСрезПоследних
	|		ПО ВТ_Менеджеры.Подразделение = КД_НазначенияТорговыхПредставителейСрезПоследних.Подразделение
	|			И ВТ_Менеджеры.Менеджер = КД_НазначенияТорговыхПредставителейСрезПоследних.Менеджер
	|ГДЕ
	|	КД_НазначенияТорговыхПредставителейСрезПоследних.Статус <> ЗНАЧЕНИЕ(Перечисление.СтатусыСотрудников.Уволен)";
	
	#КонецОбласти
	
	запрос.УстановитьПараметр("Ссылка", данныеЗаполнения);
	запрос.УстановитьПараметр("ДатаНачала", НачалоМесяца(данныеЗаполнения.Дата));
	запрос.УстановитьПараметр("ДатаОкончания", КонецМесяца(данныеЗаполнения.Дата));
	
	результатЗапроса = запрос.ВыполнитьПакет();
	
	ЭтотОбъект.ИсходныеДанные.Загрузить(результатЗапроса[2].Выгрузить());
	ЭтотОбъект.БазыРасчетаЗарплаты.Загрузить(результатЗапроса[3].Выгрузить());
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
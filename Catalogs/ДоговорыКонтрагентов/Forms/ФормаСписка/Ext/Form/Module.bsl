
&НаСервере
Процедура КомандаУстановитьТекущийДоговорНаСервере()
	
	Если Не ПравоДоступа("Изменение", Метаданные.Справочники.ДоговорыКонтрагентов) Тогда
		ВызватьИсключение НСтр("ru = 'Недостаточно прав для изменения договоров.'");
		Возврат;
	КонецЕсли;
	
	текущаяСтрока = элементы.Список.ТекущаяСтрока;
	
	Если текущаяСтрока.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст =
	"ВЫБРАТЬ
	|	ДоговорыКонтрагентов.Ссылка,
	|	ЛОЖЬ КАК ТекущийДоговор
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|ГДЕ
	|	ДоговорыКонтрагентов.Ссылка <> &Ссылка
	|	И ДоговорыКонтрагентов.ТекущийДоговор = ИСТИНА
	|	И ДоговорыКонтрагентов.Организация = &Организация
	|	И ДоговорыКонтрагентов.Владелец = &Владелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДоговорыКонтрагентов.Ссылка,
	|	НЕ ДоговорыКонтрагентов.ТекущийДоговор
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|ГДЕ
	|	ДоговорыКонтрагентов.Ссылка = &Ссылка
	|	И ДоговорыКонтрагентов.Владелец = &Владелец";
		
	#КонецОбласти 
	
	запрос.УстановитьПараметр("Ссылка", текущаяСтрока);
	запрос.УстановитьПараметр("Организация", текущаяСтрока.Организация);
	запрос.УстановитьПараметр("Владелец", текущаяСтрока.Владелец);
	
	НачатьТранзакцию();
	
	результатЗапроса = запрос.Выполнить();
	
	блокировка = Новый БлокировкаДанных;
	элементБлокировки = блокировка.Добавить();
	элементБлокировки.Область = "Справочник.ДоговорыКонтрагентов";
	элементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	элементБлокировки.ИсточникДанных = результатЗапроса.Выгрузить();
	элементБлокировки.ИспользоватьИзИсточникаДанных("Ссылка", "Ссылка");
	блокировка.Заблокировать(); 
	
	выборка = результатЗапроса.Выбрать();
	Пока выборка.Следующий() Цикл
		справочникОбъект = выборка.Ссылка.ПолучитьОбъект();
		справочникОбъект.ТекущийДоговор = выборка.ТекущийДоговор;
		справочникОбъект.Записать();
	КонецЦикла;
	
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаУстановитьТекущийДоговор(Команда)
	
	КомандаУстановитьТекущийДоговорНаСервере();
	
	Оповестить("ИзмененОсновнойДоговорКонтрагента");
	
	Элементы.Список.Обновить();
	
КонецПроцедуры

&НаСервере
Процедура КомандаТестНаСервере()
	
	текущаяСтрока = элементы.Список.ТекущаяСтрока;
	
	//выборка = Справочники.ДоговорыКонтрагентов.Выбрать(,, Новый Структура("Организация", текущаяСтрока.Организация));
	выборка = Справочники.ДоговорыКонтрагентов.Выбрать(,, );
	Пока выборка.Следующий() Цикл
		сообщить(Формат(выборка.НомерДоговора, "ЧДЦ="));
		сообщить(Число(выборка.НомерДоговора));
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаТест(Команда)
	КомандаТестНаСервере();
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	имяКаталогаУдалить = Параметры.имяКаталогаУдалить;
	Сообщение = Параметры.Сообщение;
	Для Каждого вложение Из Параметры.Вложения Цикл
		СписокВложения.Добавить(вложение.Значение);
	КонецЦикла;
	Для Каждого получатель Из Параметры.Получатели Цикл
		СписокПолучатели.Добавить(получатель.Значение);
	КонецЦикла;
	Тема = Параметры.Тема;
	Отправитель = Параметры.Отправитель;
	
	#Область изменения_20180601_Карпачев_А_Ю
	АдаптироватьПодМашинныйРазбор = Параметры.АдаптироватьПодМашинныйРазбор;
	#КонецОбласти
	
	#Область изменения_20171017_Карпачев_А_Ю
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	запрос.Текст = 
	"ВЫБРАТЬ
	|	ИнтернетПочтовыеПрофилиПользователей.Ссылка
	|ИЗ
	|	Справочник.ИнтернетПочтовыеПрофилиПользователей КАК ИнтернетПочтовыеПрофилиПользователей
	|ГДЕ
	|	ИнтернетПочтовыеПрофилиПользователей.Владелец = &Владелец";
	#КонецОбласти
	
	запрос.УстановитьПараметр("Владелец",Справочники.Пользователи.НайтиПоНаименованию(ПользователиИнформационнойБазы.ТекущийПользователь().Имя ,Истина));
	
	результат = запрос.Выполнить().Выгрузить();
	
	Для Каждого профиль Из результат Цикл
		
		Если Не ЗначениеЗаполнено(Отправитель) Тогда
			Отправитель = профиль.Ссылка;
		КонецЕсли;
		
		Элементы.Отправитель.СписокВыбора.Добавить(профиль.Ссылка);
		
	КонецЦикла;
	
	#КонецОбласти
	
КонецПроцедуры

&НаСервере
Процедура ИнтернетПочтовоеСообщениеОтправитьНаСервере(Отказ)
	
	Если СписокПолучатели.Количество() = 0 Тогда
		Сообщить("Укажите минимум один электронный адресс получатель!");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	//#Область изменения_20171018_Карпачев_А_Ю
	//Если Не ЗначениеЗаполнено(Отправитель) Тогда
	//	Сообщить("Не указан отправитель!");
	//	Возврат;
	//КонецЕсли;
	//#КонецОбласти
	
	интернетПочтовоеСообщениеСостав = Новый Структура;
	интернетПочтовоеСообщениеСостав.Вставить("сообщение", Сообщение);
	нпп = 0;
	Для Каждого вложение Из СписокВложения Цикл
		нпп = нпп + 1;
		интернетПочтовоеСообщениеСостав.Вставить("вложение" + нпп, вложение.Значение);
	КонецЦикла;
	нпп = 0;
	Для Каждого получатель Из СписокПолучатели Цикл
		нпп = нпп + 1;
		интернетПочтовоеСообщениеСостав.Вставить("получатель" + нпп, получатель.Значение);
	КонецЦикла;
	интернетПочтовоеСообщениеСостав.Вставить("тема", Тема);
	#Область изменения_20171017_Карпачев_А_Ю
	интернетПочтовоеСообщениеСостав.Вставить("отправитель", Отправитель);
	#КонецОбласти
	
	#Область изменения_20180601_Карпачев_А_Ю
	интернетПочтовоеСообщениеСостав.Вставить("АдаптироватьПодМашинныйРазбор", АдаптироватьПодМашинныйРазбор);
	#КонецОбласти
	
	ОтправкаСообщенийСервер.ИнтернетПочтовоеСообщениеОтправить(интернетПочтовоеСообщениеСостав);
	
	УдалитьФайлы(имяКаталогаУдалить);
	
КонецПроцедуры

&НаКлиенте
Процедура ИнтернетПочтовоеСообщениеОтправить(Команда)
	
	отказ = Ложь;
	
	ИнтернетПочтовоеСообщениеОтправитьНаСервере(отказ);
	
	Если Не отказ Тогда
		Элементы.ФормаИнтернетПочтовоеСообщениеОтправить.Видимость = Ложь;
		Элементы.ФормаЗакрыть.Видимость = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ФормаЗакрыть(Команда)
	ЭтаФорма.Закрыть();
КонецПроцедуры

#Область КомандыФормы

&НаКлиенте
Процедура КомандаВыполнить(команда)
	
	табличныйДокумент = Новый ТабличныйДокумент;
	
	СформироватьНаСервере(табличныйДокумент);
	
	табличныйДокумент.АвтоМасштаб 			= Истина;
	табличныйДокумент.ОтображатьСетку 		= Ложь;
	табличныйДокумент.ОтображатьЗаголовки 	= Ложь;
	
	табличныйДокумент.Показать("Список ТРТ по маршруту");

	
КонецПроцедуры

#КонецОбласти

#Область ДополнительныеПроцедурыИФункции

&НаСервере
Процедура СформироватьНаСервере(табличныйДокумент)
	
	запрос = Новый Запрос;
	
	#Область ТекстЗапроса
	
	запрос.Текст = 
	"ВЫБРАТЬ
	|	ПродажиОбороты.Контрагент.Код,
	|	ПродажиОбороты.Контрагент,
	|	ПродажиОбороты.Менеджер,
	|	ПродажиОбороты.Подразделение,
	|	СУММА(ПродажиОбороты.КоличествоОборот) КАК КоличествоОборот,
	|	ПродажиОбороты.КаналСбыта,
	|	ПродажиОбороты.ГруппаПродукта,
	|	КД_КатегорииТорговыхТочекСрезПоследних.КатегорияТТ,
	|	Контрагенты.ГПСДолгота КАК ГПСДолгота,
	|	Контрагенты.ГПСШирота КАК ГПСШирота,
	|	Контрагенты.АдресДоставкиГород КАК АдресДоставкиГород
	|ИЗ
	|	РегистрНакопления.Продажи.Обороты(
	|			&НачалоПериода,
	|			&КонецПериода,
	|			Авто,
	|			Подразделение = &Подразделение
	|				И Менеджер = &Менеджер
	|				И КаналСбыта В (&КаналыСбыта)) КАК ПродажиОбороты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КД_КатегорииТорговыхТочек.СрезПоследних(&КонецПериода, ) КАК КД_КатегорииТорговыхТочекСрезПоследних
	|		ПО ПродажиОбороты.Контрагент = КД_КатегорииТорговыхТочекСрезПоследних.ТорговаяТочка
	|			И ПродажиОбороты.Подразделение = КД_КатегорииТорговыхТочекСрезПоследних.Подразделение
	|			И ПродажиОбороты.ГруппаПродукта = КД_КатегорииТорговыхТочекСрезПоследних.ГруппаПродукции
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО ПродажиОбороты.Контрагент = Контрагенты.Ссылка
	|ГДЕ
	|	ПродажиОбороты.КоличествоОборот > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ПродажиОбороты.Менеджер,
	|	ПродажиОбороты.Контрагент,
	|	ПродажиОбороты.Подразделение,
	|	ПродажиОбороты.КаналСбыта,
	|	ПродажиОбороты.ГруппаПродукта,
	|	ПродажиОбороты.Контрагент.Код,
	|	КД_КатегорииТорговыхТочекСрезПоследних.КатегорияТТ,
	|	Контрагенты.ГПСДолгота,
	|	Контрагенты.ГПСШирота,
	|	Контрагенты.АдресДоставкиГород
	|
	|УПОРЯДОЧИТЬ ПО
	|	АдресДоставкиГород";
	
	#КонецОбласти
	
	запрос.УстановитьПараметр("НачалоПериода", 	ПериодПродаж.ДатаНачала);
	запрос.УстановитьПараметр("КонецПериода",	ПериодПродаж.ДатаОкончания);
	запрос.УстановитьПараметр("Подразделение",	Подразделение);
	запрос.УстановитьПараметр("КаналыСбыта",	СписокКаналовСбыта);
	запрос.УстановитьПараметр("Менеджер",		Менеджер);
	запрос.УстановитьПараметр("КатегорииТТ",	СписокКатегорийТТ);
	
	
	результат = запрос.Выполнить();
	выборка = результат.Выбрать();
	
	//отчетОбъект = РеквизитФормыВЗначение("Объект");
	//макет = отчетОбъект.ПолучитьМакет("Макет");
	
	макет = Документы.ЗаданиеКонтролеруОКК.ПолучитьМакет("СписокКлиентовМаршрута");
	
	областьШапка = макет.ПолучитьОбласть("Шапка");
	областьШапка.Параметры.ДатаНачала 		= ПериодПродаж.ДатаНачала;
	областьШапка.Параметры.ДатаОкончания 	= ПериодПродаж.ДатаОкончания;
	
	табличныйДокумент.Вывести(областьШапка);
	
	Пока выборка.Следующий() Цикл
		
		областьТалоны = макет.ПолучитьОбласть("Строка");
		
		ЗаполнитьЗначенияСвойств(областьТалоны.Параметры, выборка);
		
		//областьТалоны.Параметры.КонтрагентКод = выборка.КонтрагентКод;;
		//областьТалоны.Параметры.Контрагент = выборка.Контрагент;
		//областьТалоны.Параметры.Менеджер = выборка.Менеджер;
		//областьТалоны.Параметры.КатегорияТТ = выборка.КатегорияТТ;
		//областьТалоны.Параметры.АдресДоставкиГород = выборка.АдресДоставкиГород;
		
		табличныйДокумент.Вывести(областьТалоны);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти
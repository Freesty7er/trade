


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

&НаСервереБезКонтекста
// Получить коэффициент единицы измерения.
//
Функция ПолучитьТекущуюВерсиюКАртинки(ФайлКартинки)

	Возврат ФайлКартинки.ТекущаяВерсия; 	

КонецФункции // ПолучитьКоэффициентЕдиницыИзмерения()


// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
// Процедура - обработчик события ПриСозданииНаСервере.
//
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
			
	// Обработчик механизма "Свойства".
	//УправлениеСвойствами.ПриСозданииНаСервере(ЭтаФорма, Объект, "СтраницаДополнительныеРеквизиты");
	
	// Установка значения реквизита АдресКартинки.
	//ФайлКартинки = Объект.ФайлКартинки;
	//Если Не ФайлКартинки.Пустая() Тогда
	//	АдресКартинки = РаботаСФайламиВызовСервера.ПолучитьНавигационнуюСсылкуДляОткрытия(ФайлКартинки.ТекущаяВерсия)
	//Конецесли;
	
	
	// Обработчик подсистемы запрета редактирования реквизитов объектов
	//ЗапретРедактированияРеквизитовОбъектов.ЗаблокироватьРеквизиты(ЭтаФорма);
	
	//ЭлементМодифицирован = Ложь;
	
	// Обработчик подсистемы "Дополнительные отчеты и обработки"
	//ДополнительныеОтчетыИОбработки.ПриСозданииНаСервере(ЭтаФорма);
	
	//Если ПравоДоступа("Редактирование", Метаданные.Справочники.Номенклатура) Тогда
		КаталогКартинок = БПАГ.БПАГПолучитьНастройку("1СКаталогОбмена") + "Images\";
	//КонецЕсли; 
	
КонецПроцедуры // ПриСозданииНаСервере()




&НаКлиенте
Процедура ФайлКартинкиПриИзменении(Элемент)
	
	// Отслеживание изменения картинки и соответствующее обновление
	// реквизита АдресКартинки.
	
	//////ФайлКартинки = ПолучитьТекущуюВерсиюКАртинки(Объект.ФайлКартинки);
	//////Если Не ФайлКартинки.Пустая() Тогда
	//////	ТекущаяВерсияКартинки = ПолучитьТекущуюВерсиюКАртинки(Объект.ФайлКартинки);
	//////	АдресКартинки = РаботаСФайламиВызовСервера.ПолучитьНавигационнуюСсылкуДляОткрытия(ТекущаяВерсияКартинки);
	//////Иначе 	
	//////	АдресКартинки = "";
	//////Конецесли;
	
КонецПроцедуры

//	----------------------------------------------------------------------------
//	ПанАгент: РаботаСКартинками
//

&НаКлиенте
Процедура ДобавитьКартинкуСДиска(Команда)
	
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогОткрытияФайла.ПредварительныйПросмотр = Истина;
	ДиалогОткрытияФайла.Заголовок = "Выберите файл";
	ДиалогОткрытияФайла.МножественныйВыбор = Истина;
	//ДиалогОткрытияФайла.ПолноеИмяФайла = "";
	ДиалогОткрытияФайла.Фильтр = 
		"Все картинки (*.bmp;*.dib;*.rle;*.jpg;*.jpeg;*.tif;*.gif;*.png;*.ico;*.wmf;*.emf)|*.bmp;*.dib;*.rle;*.jpg;*.jpeg;*.tif;*.gif;*.png;*.ico;*.wmf;*.emf|" 
		+ "Веб-страницы (*.htm;*.html)|*.htm;*.html|"
		+ "Все файлы (*.*)|*.*|"
		+ "Формат bmp (*.bmp;*.dib;*.rle)|*.bmp;*.dib;*.rle|"
		+ "Формат JPEG (*.jpg;*.jpeg)|*.jpg;*.jpeg|"
		+ "Формат TIFF (*.tif)|*.tif|"
		+ "Формат GIF (*.gif)|*.gif|"
		+ "Формат PNG (*.png)|*.png|"
		+ "Формат icon (*.ico)|*.ico|"
		+ "Формат метафайл (*.wmf;*.emf)|*.wmf;*.emf|"; // картинки

	Если ДиалогОткрытияФайла.Выбрать() Тогда
		МассивФайлов = ДиалогОткрытияФайла.ВыбранныеФайлы;
		Для Каждого ИмяФайла Из ДиалогОткрытияФайла.ВыбранныеФайлы Цикл
			
			ФайлКартинки = Новый Файл(ИмяФайла);
			ДобавитьКартинку(ФайлКартинки);
						
		КонецЦикла;
		
		ОбновитьКартинки();
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УдалитьКртинку(Команда)
	
КонецПроцедуры

&НаКлиенте
Функция ДобавитьКартинку(Файл)
	
	НовоеМестоположениеКартинки = КаталогКартинок + БПАГ.ПревратитьСтрокуВТранслит(Файл.Имя);
	НовыйФайлКартинки = Новый Файл(НовоеМестоположениеКартинки);
	
	Если ВРег(Файл.ПолноеИмя) = ВРег(НовоеМестоположениеКартинки) Тогда //картинка уже лежит на нужном месте
		НоваяКартинка = Объект.Картинки.Добавить();
		НоваяКартинка.Имя = НовыйФайлКартинки.Имя;
		Возврат Истина;
	ИначеЕсли НовыйФайлКартинки.Существует() Тогда
		Если Вопрос("В каталоге картинок уже существует файл с именем " + НовыйФайлКартинки.Имя + "! Заменить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		КопироватьФайл(Файл.ПолноеИмя, НовоеМестоположениеКартинки);
		
		НоваяКартинка = Объект.Картинки.Добавить();
		НоваяКартинка.Имя = НовыйФайлКартинки.Имя;
	Исключение
		Сообщить(ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
	Возврат Истина;
КонецФункции

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если КаталогКартинок = "ОшибкаImages\" Тогда
		Элементы.ПанельКартинок.Видимость = Ложь;
	Иначе
		Файл = Новый Файл(КаталогКартинок);
		Если Не Файл.Существует() Тогда
			Попытка
				СоздатьКаталог(КаталогКартинок);
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
		
		ОбновитьКартинки();
		
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьКартинки()
	
	Для Каждого тмпКартинка Из Объект.Картинки Цикл
		
		ФайлКартинки = Новый Файл(КаталогКартинок + тмпКартинка.Имя);
		
		Если (ФайлКартинки.Существует()) И (ФайлКартинки.ПолноеИмя + "\" <> КаталогКартинок) Тогда
			
			ДвоичныеДанные = Новый ДвоичныеДанные(ФайлКартинки.ПолноеИмя);
			АдресКартинки = ПоместитьВоВременноеХранилище(ДвоичныеДанные, Неопределено);
	
		КонецЕсли;		
		
	КонецЦикла;
	
КонецПроцедуры


&НаКлиенте
Процедура КД_ВидНачалоВыбора(элемент, данныеВыбора, стандартнаяОбработка)
	УстановитьПараметрыВыбораКД_ВидНаСервере();
КонецПроцедуры

&НаСервере
Процедура УстановитьПараметрыВыбораКД_ВидНаСервере()
	
	новыйПараметр = Новый ПараметрВыбора("Отбор.Владелец", Объект.КД_Группа.Родитель);
	
	новыйМассив = Новый Массив();
	новыйМассив.Добавить(новыйПараметр);
	
	новыеПараметры = Новый ФиксированныйМассив(новыйМассив);
	Элементы.КД_Вид.ПараметрыВыбора = новыеПараметры;
	
КонецПроцедуры

&НаКлиенте
Процедура КД_ГруппаПриИзменении(Элемент)
	КД_ГруппаПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура КД_ГруппаПриИзмененииНаСервере()
	Если Не Объект.КД_Вид.Владелец = Объект.КД_Группа.Родитель Тогда
		Объект.КД_Вид = Неопределено;
		Объект.КД_Тип = Неопределено;
	КонецЕсли;
КонецПроцедуры

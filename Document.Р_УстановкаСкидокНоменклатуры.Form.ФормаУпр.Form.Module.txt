Перем мФормаДокумента;
Перем мКолонкиСоставНабора;

Перем мКартинкаСерийныеНомера;

Перем CсылкаДок;

Перем СтруктураИсходныхПараметров;
//Перем мЕстьЦена;

//////////////////////////////////////////////////////////////////////////////////
//// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

&НаСервере

// Процедура устанавливает значения исходных параметров.
//
Процедура УстановитьЗначенияИсходныхПараметров()
	
	Перем ДоступностьКнСерийныеНомера;
	
	ЗаголовокФормы = Неопределено;
	мТолькоПросмотр = Неопределено;
	
	СтруктураИсходныхПараметров.Свойство("Номенклатура",				Объект.Номенклатура);
	СтруктураИсходныхПараметров.Свойство("Количество",					Объект.Количество);
	СтруктураИсходныхПараметров.Свойство("ЕдиницаИзмерения",			Объект.ЕдиницаИзмерения);
	СтруктураИсходныхПараметров.Свойство("ДокументОбъект",				CсылкаДок);
	СтруктураИсходныхПараметров.Свойство("ФормаДокумента",				мФормаДокумента);
	СтруктураИсходныхПараметров.Свойство("ИмяТабличнойЧасти",			Объект.ИмяТабличнойЧасти);
	СтруктураИсходныхПараметров.Свойство("КлючСтроки",					Объект.КлючСтроки);
	СтруктураИсходныхПараметров.Свойство("ЗаголовокФормы",				ЗаголовокФормы);

	Если ЗаголовокФормы <> Неопределено Тогда
		ЭтаФорма.Заголовок = ЗаголовокФормы;
	КонецЕсли;

КонецПроцедуры // УстановитьЗначенияИсходныхПараметров()

&НаКлиенте
// Процедура устанавливает отбор табличной части по реквизиту "КлючСтроки".
//
Процедура УстановитьОтборТабЧасти()
	
	Элементы.СоставНабора.ОтборСтрок = Новый ФиксированнаяСтруктура("КлючСтроки", Объект.КлючСтроки);
	
КонецПроцедуры // УстановитьОтборТабЧасти()

//////////////////////////////////////////////////////////////////////////////////
//// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ВНЕШНИМ ВИДОМ ФОРМЫ


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	СтруктураИсходныхПараметров = Параметры.СтруктураИсходныхПараметров;
	СтруктураИсходныхПараметров.Свойство("Номенклатура",				Объект.Номенклатура);
	СтруктураИсходныхПараметров.Свойство("Количество",					Объект.Количество);
	СтруктураИсходныхПараметров.Свойство("ЕдиницаИзмерения",			Объект.ЕдиницаИзмерения);
	СтруктураИсходныхПараметров.Свойство("ДокументОбъект",				CсылкаДок);
	СтруктураИсходныхПараметров.Свойство("ФормаДокумента",				мФормаДокумента);
	СтруктураИсходныхПараметров.Свойство("ИмяТабличнойЧасти",			Объект.ИмяТабличнойЧасти);
	СтруктураИсходныхПараметров.Свойство("КлючСтроки",					Объект.КлючСтроки);
	//СтруктураИсходныхПараметров.Свойство("ЗаголовокФормы",				ЗаголовокФормы);

	// Проверим тип реквизита формы СтруктураПараметровФормы. Должен быть "Структура".
	// При неверном типе не будем запускать подбор.
	Если ТипЗнч(СтруктураИсходныхПараметров) <> Тип("Структура") Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;

	УстановитьЗначенияИсходныхПараметров();

	Этаформа.Объект.СоставНабора.Загрузить(CсылкаДок.СоставНабора.Выгрузить());
	
КонецПроцедуры // ПередОткрытием()

&НаКлиенте
// Процедура - обработчик события "ПриОткрытии" формы.
//
Процедура ПриОткрытии()

	Если Объект.КлючСтроки = 1 Тогда
		Элементы.СоставНабораР_ПроцентСкидки.Видимость = Ложь;
	КонецЕсли;
	
	Если НЕ Объект.Количество = 0 Тогда
		Элементы.СоставНабораКоличество.Видимость= Ложь;
	КонецЕсли;
	
	УстановитьОтборТабЧасти();

КонецПроцедуры // ПриОткрытии()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ТЧ СОСТАВ НАБОРА

// Процедура - обработчик события "ПриНачалеРедактирования" табличной части
//
Процедура СоставНабораПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)

	Если НоваяСтрока Тогда
		Элемент.ТекущиеДанные.КлючСтроки = Объект.КлючСтроки;
	КонецЕсли;

КонецПроцедуры // СоставНабораПриНачалеРедактирования()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

&НаКлиенте
// Обработчик события "ПриИзменении" реквизита "Номенклатура" в ТЧ "СоставНабора".
//
Процедура СоставНабораНоменклатураПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставНабора.ТекущиеДанные;
	
	ТекущаяСтрока.ЕдиницаИзмерения = ПолучитьЕдинициИзмерения(ТекущаяСтрока.Номенклатура);
	
	Если НЕ Объект.Количество = 0 Тогда
		ТекущаяСтрока.Количество = 1;
	КонецЕсли;
	
	ТекущаяСтрока.КлючСтроки = Объект.КлючСтроки;

	//
	//УстановитьОтборТабЧасти();

	
КонецПроцедуры // СоставНабораНоменклатураПриИзменении()

&НаСервере
// Обработчик события "ПриИзменении" реквизита "Номенклатура" в ТЧ "СоставНабора".
//
Функция ПолучитьЕдинициИзмерения(Номенклатура)

	Возврат Номенклатура.ЕдиницаИзмерения;
	
КонецФункции // СоставНабораНоменклатураПриИзменении(

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	//Если ЭтаФорма.Модифицированность Тогда
	//	Ответ = Вопрос("Данные были изменены. Сохранить изменения?", РежимДиалогаВопрос.ДаНетОтмена);
	//	Если Ответ = КодВозвратаДиалога.Да Тогда
			ПередЗакрытиемНаСервере();
	//	ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда
	//		Отказ = Истина;
	//	КонецЕсли;
	//КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура ПередЗакрытиемНаСервере()
	
	//ЗаписатьСоставНабораВДокумент();
	
КонецПроцедуры

&НаКлиенте
Процедура ОК(Команда)
	
	Результат = Новый Структура();
	Результат.Вставить("СоставНабора", ПолучитьТаблицуБонусов());
	Закрыть(Результат);

КонецПроцедуры

//&НаСервере
Функция ПолучитьТаблицуБонусов()
	
	Возврат Объект.СоставНабора.Выгрузить()
	
КонецФункции

&НаКлиенте
Процедура СоставНабораКоличествоПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.СоставНабора.ТекущиеДанные;
	ОчиститьСообщения();
	Для Каждого Строка ИЗ Объект.СоставНабора Цикл
		Если Строка.КлючСтроки = ТекущаяСтрока.КлючСтроки Тогда
			//Если ((Цел(Строка.Количество) - Строка.Количество) = 0 И НЕ (Цел(ТекущаяСтрока.Количество) - ТекущаяСтрока.Количество) = 0)
			//	ИЛИ  НЕ((Цел(Строка.Количество) - Строка.Количество) = 0 И (Цел(ТекущаяСтрока.Количество) - ТекущаяСтрока.Количество) = 0) Тогда
				
				Если НЕ (((Цел(ТекущаяСтрока.Количество) - ТекущаяСтрока.Количество) = 0) = ((Цел(Строка.Количество) - Строка.Количество) = 0)) Тогда
				Сообщить("Одновременно можно использовать или только делимые товары, или только штучные. В предыдущих строках использовались " + ?((Цел(Строка.Количество) - Строка.Количество) = 0, "штучные", "делимые") + " товары");
				ТекущаяСтрока.Количество = 0;
				Прервать;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
 
	
	//ТекущаяСтрока.ЕдиницаИзмерения = ПолучитьЕдинициИзмерения(ТекущаяСтрока.Номенклатура);
	//
	//ТекущаяСтрока.Количество = 1;
	//
	//ТекущаяСтрока.КлючСтроки = Объект.КлючСтроки;

КонецПроцедуры



///////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ

//мКолонкиСоставНабора = Элементы.СоставНабора.ПодчиненныеЭлементы;//Элементы.СоставНабора.Колонки;
////Новый Структура("СтруктураИсходныхПараметров", СтруктураПараметров)

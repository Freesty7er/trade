//#Область изменения_20171017_Карпачев_А_Ю
//Функция ПолучитьИнтернетПочтовыйПрофиль()
Функция ПолучитьИнтернетПочтовыйПрофиль(почтовыйПрофиль)
	
	интернетПочтовыйПрофиль = Новый ИнтернетПочтовыйПрофиль;
	
	Если ЗначениеЗаполнено(почтовыйПрофиль) Тогда
		
		интернетПочтовыйПрофиль.АдресСервераPOP3	 = почтовыйПрофиль.АдресСервераPOP3;
		интернетПочтовыйПрофиль.ИспользоватьSSLPOP3	 = почтовыйПрофиль.ИспользоватьSSLPOP3;
		интернетПочтовыйПрофиль.ПортPOP3			 = почтовыйПрофиль.ПортPOP3;
		
		интернетПочтовыйПрофиль.АдресСервераSMTP	 = почтовыйПрофиль.АдресСервераSMTP;
		интернетПочтовыйПрофиль.ИспользоватьSSLSMTP	 = почтовыйПрофиль.ИспользоватьSSLSMTP;
		интернетПочтовыйПрофиль.АутентификацияSMTP	 = СпособSMTPАутентификации.Login;
		интернетПочтовыйПрофиль.ПортSMTP			 = почтовыйПрофиль.ПортSMTP;
		
		интернетПочтовыйПрофиль.Пользователь		 = почтовыйПрофиль.Пользователь;
		интернетПочтовыйПрофиль.Пароль				 = почтовыйПрофиль.Пароль;
		интернетПочтовыйПрофиль.ПользовательSMTP	 = почтовыйПрофиль.ПользовательSMTP;
		интернетПочтовыйПрофиль.ПарольSMTP			 = почтовыйПрофиль.ПарольSMTP;
		
	Иначе
		
		интернетПочтовыйПрофиль.АдресСервераPOP3	 = "pop.gmail.com";
		интернетПочтовыйПрофиль.ИспользоватьSSLPOP3	 = Истина;
		интернетПочтовыйПрофиль.ПортPOP3			 = 995;
		
		интернетПочтовыйПрофиль.АдресСервераSMTP	 = "smtp.gmail.com";
		интернетПочтовыйПрофиль.ИспользоватьSSLSMTP	 = Истина;
		интернетПочтовыйПрофиль.АутентификацияSMTP	 = СпособSMTPАутентификации.Login;
		интернетПочтовыйПрофиль.ПортSMTP			 = 465;
		
		интернетПочтовыйПрофиль.Пользователь		 = "buhgalterdokuments@gmail.com";
		интернетПочтовыйПрофиль.Пароль				 = "ljrevtyns";
		интернетПочтовыйПрофиль.ПользовательSMTP	 = "buhgalterdokuments@gmail.com";
		интернетПочтовыйПрофиль.ПарольSMTP			 = "ljrevtyns";
		
	КонецЕсли;
	
	//#КонецОбласти
	
	Возврат интернетПочтовыйПрофиль;
	
КонецФункции

Процедура ИнтернетПочтовоеСообщениеСоставРазобрать(состав, получатели, тема, сообщения, вложения)
	
	//получательНомер	 = 0;
	сообщениеНомер	 = 0;
	//вложениеНомер	 = 0;
	
	Для Каждого элементСостав Из состав Цикл
		
		Если СтрЧислоВхождений(НРег(элементСостав.Ключ), "получатель") > 0 Тогда
			
			Если получатели = Неопределено Тогда
				получатели = Новый Структура;
			КонецЕсли;
			
			//получательНомер = получательНомер + 1;
			
			получатели.Вставить(элементСостав.Ключ, элементСостав.Значение);
			
		ИначеЕсли НРег(элементСостав.Ключ) = "тема" Тогда
			тема = элементСостав.Значение;
		ИначеЕсли СтрЧислоВхождений(НРег(элементСостав.Ключ), "сообщение") > 0 Тогда
			
			Если сообщения = Неопределено Тогда
				сообщения = Новый Структура;
			КонецЕсли;
			
			//сообщениеНомер = сообщениеНомер + 1;
			
			сообщения.Вставить(элементСостав.Ключ, элементСостав.Значение);
			
		ИначеЕсли СтрЧислоВхождений(НРег(элементСостав.Ключ), "вложение") > 0 Тогда
			
			Если вложения = Неопределено Тогда
				вложения = Новый Структура;
			КонецЕсли;
			
			//вложениеНомер = вложениеНомер + 1;
			
			вложения.Вставить(элементСостав.Ключ, элементСостав.Значение);
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

//#Область изменения_20171017_Карпачев_А_Ю
//Функция ИнтернетПочтовоеСообщениеОтправить(интернетПочтовоеСообщениеСостав) Экспорт
Процедура ИнтернетПочтовоеСообщениеОтправить(интернетПочтовоеСообщениеСостав) Экспорт
	//#КонецОбласти
	
	#Область изменения_20171017_Карпачев_А_Ю
	
	//почтовыйПрофиль = Справочники.ИнтернетПочтовыеПрофилиПользователей.НайтиПоНаименованию(интернетПочтовоеСообщениеСостав.Отправитель, Истина);
	
	интернетПочтовыйПрофиль = ПолучитьИнтернетПочтовыйПрофиль(интернетПочтовоеСообщениеСостав.Отправитель);
	
	Если интернетПочтовыйПрофиль = Неопределено Тогда
		
		Сообщить("Интернет почтовое сообщение: не удалось определить интернет почтовый профиль отправителя");
		
		Возврат;
		
	КонецЕсли;
	
	#КонецОбласти
	
	интернетПочта = Новый ИнтернетПочта;
	
	интернетПочтовоеСообщениеПолучатели	 = Неопределено;
	интернетПочтовоеСообщениеТема		 = Неопределено;
	интернетПочтовоеСообщениеСообщения	 = Неопределено;
	интернетПочтовоеСообщениеВложения	 = Неопределено;
	
	ИнтернетПочтовоеСообщениеСоставРазобрать(интернетПочтовоеСообщениеСостав,интернетПочтовоеСообщениеПолучатели,интернетПочтовоеСообщениеТема,интернетПочтовоеСообщениеСообщения,интернетПочтовоеСообщениеВложения);
	
	интернетПочтовоеСообщение = Новый ИнтернетПочтовоеСообщение;
	
	Если интернетПочтовоеСообщениеСообщения <> Неопределено Тогда
		Для Каждого элементИнтернетПочтовоеСообщениеСообщения Из интернетПочтовоеСообщениеСообщения Цикл
			интернетПочтовоеСообщениеТекст			 = интернетПочтовоеСообщение.Тексты.Добавить(элементИнтернетПочтовоеСообщениеСообщения.Значение);
			интернетПочтовоеСообщениеТекст.ТипТекста = ТипТекстаПочтовогоСообщения.ПростойТекст;
		КонецЦикла;
	КонецЕсли;
	
	интернетПочтовоеСообщение.Тема = интернетПочтовоеСообщениеТема; 
	
	#Область изменения_20171017_Карпачев_А_Ю
	интернетПочтовоеСообщение.Отправитель = интернетПочтовоеСообщениеСостав.Отправитель.АдресЭлектроннойПочты;
	интернетПочтовоеСообщение.ИмяОтправителя = интернетПочтовоеСообщениеСостав.Отправитель.ОтправительИмя;
	#КонецОбласти
	
	Для Каждого элементИнтернетПочтовоеСообщениеПолучатели Из интернетПочтовоеСообщениеПолучатели Цикл
		интернетПочтовоеСообщение.Получатели.Добавить(элементИнтернетПочтовоеСообщениеПолучатели.Значение);
	КонецЦикла;
	
	#Область изменения_20180531_Карпачев_А_Ю
	Если интернетПочтовоеСообщениеСостав.Свойство("АдаптироватьПодМашинныйРазбор") Тогда
		АдаптироватьПодМашинныйРазбор = интернетПочтовоеСообщениеСостав.АдаптироватьПодМашинныйРазбор;
	Иначе
		АдаптироватьПодМашинныйРазбор = Ложь;
	КонецЕсли;
	#КонецОбласти
	
	Если интернетПочтовоеСообщениеВложения <> Неопределено Тогда
		Для Каждого элементИнтернетПочтовоеСообщениеВложения Из интернетПочтовоеСообщениеВложения Цикл
			#Область изменения_20180531_Карпачев_А_Ю
			//интернетПочтовоеСообщение.Вложения.Добавить(элементИнтернетПочтовоеСообщениеВложения.Значение, элементИнтернетПочтовоеСообщениеВложения.Ключ);
			Если АдаптироватьПодМашинныйРазбор Тогда
				интернетПочтовоеСообщение.Вложения.Добавить(элементИнтернетПочтовоеСообщениеВложения.Значение);
			Иначе
				интернетПочтовоеСообщение.Вложения.Добавить(элементИнтернетПочтовоеСообщениеВложения.Значение, элементИнтернетПочтовоеСообщениеВложения.Ключ);
			КонецЕсли;
			#КонецОбласти
		КонецЦикла;
	КонецЕсли;
	
	Попытка
		интернетПочта.Подключиться(интернетПочтовыйПрофиль);
		Сообщить("Интернет почтовое сообщение: подключенено");
		интернетПочта.Послать(интернетПочтовоеСообщение);
		Сообщить("Интернет почтовое сообщение: сообщение отправлено");
	Исключение
		Сообщить("Интернет почтовое сообщение: не удалось подключиться к серверу");
		Сообщить(ОписаниеОшибки());
	КонецПопытки;
	
	интернетПочта.Отключиться();
	Сообщить("Интернет почтовое сообщение: соединение завершено");
	
	//#Область изменения_20171017_Карпачев_А_Ю
	//КонецФункции
КонецПроцедуры
//#КонецОбласти

Процедура ПриЗаписи(отказ)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если Не РольДоступна("УстановкаМаксимальныхСкидок") Тогда
		
		запрос = Новый Запрос;
		
		#Область ТекстЗапроса
		
		запрос.Текст =
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Группа,
		|	ВЫБОР
		|		КОГДА &ПроцентСкидки > ЕСТЬNULL(МаксимальноРазрешенныеСкидкиСрезПоследних.ПроцентСкидки, 99999)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЕстьОшибка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МаксимальноРазрешенныеСкидки.СрезПоследних(, Группа = &Группа) КАК МаксимальноРазрешенныеСкидкиСрезПоследних
		|		ПО МаксимальноРазрешенныеСкидкиСрезПоследних.Группа = Номенклатура.Ссылка
		|ГДЕ
		|	Номенклатура.Ссылка = &Группа";
		
		#КонецОбласти
		
		запрос.УстановитьПараметр("Группа", Группа);
		запрос.УстановитьПараметр("ПроцентСкидки", ПроцентСкидки);
		
		результатЗапроса = запрос.Выполнить();
		
		естьОшибка = результатЗапроса.Выгрузить()[0].ЕстьОшибка;
		
		
		Если естьОшибка  Тогда
			сообщить("Превышена максимально разрешенная скидка.");
			отказ = Истина;
		КонецЕсли;
		
	КонецЕсли;
	
	
КонецПроцедуры
